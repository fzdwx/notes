

# 笔记

文档

https://easydoc.xyz/s/78237135/ZUqEdvA4/HqQGp9TI

-   官方笔记-基础篇：https://blog.csdn.net/hancoder/article/details/107612619
-   官方笔记-高级篇：https://blog.csdn.net/hancoder/article/details/107612746
-   官方笔记-集群篇：https://blog.csdn.net/hancoder/article/details/107612802
-   官方笔记下载地址：https://download.csdn.net/download/hancoder/12665396



https://blog.csdn.net/hancoder/article/details/106922139

# 	项目介绍

## 1.项目架构

![image-20201024173433290](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201024173433.png)





## 2.项目划分

![image-20201024175340213](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201024175340.png)







# 环境搭建

## 1、docker安装

~~~bash
#卸载系统之前的docker 
sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
                  
                  
sudo yum install -y yum-utils

# 配置镜像
sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
    
sudo yum install docker-ce docker-ce-cli containerd.io

sudo systemctl start docker
# 设置开机自启动
sudo systemctl enable docker

docker -v
sudo docker images

# 配置镜像加速
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://xdub84vk.mirror.aliyuncs.com"]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
~~~



## 2、docker安装mysql

~~~bash
# --name指定容器名字 -v目录挂载 -p指定端口映射  -e设置mysql参数 -d后台运行
sudo docker run -p 3306:3306 --name mysql \
-v /root/app/mysql/log:/var/log/mysql \
-v /root/app/mysql/data:/var/lib/mysql \
-v /root/app/mysql/conf:/etc/mysql \
-e MYSQL_ROOT_PASSWORD=root \
-d mysql:5.7


# 进入容器内部
docker exec -it 471 bash
whereis mysql
#mysql: /usr/bin/mysql /usr/lib/mysql /etc/mysql /usr/share/mysql


# 修改配置文件
vim /root/app/mysql/conf/my.cnf

[client]
default-character-set=utf8
[mysql]
default-character-set=utf8
[mysqld]
init_connect='SET collation_connection = utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
skip-name-resolve

# 重启
docker restart mysql
# 查看配置文件是否生效
docker exec -it 471 bash
root@471b51c04bd0:/# cat /etc/mysql/my.cnf 
[client]
default-character-set=utf8
[mysql]
default-character-set=utf8
[mysqld]
init_connect='SET collation_connection = utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
skip-name-resolve
~~~



## 3、docker安装redis

~~~bash
# 创建挂载目录
mkdir -p /root/app/redis/conf
touch /root/app/redis/conf/redis.conf

# 启动
docker run -p 6379:6379 --name redis \
-v /root/app/redis/data:/data \
-v /root/app/redis/conf/redis.conf:/etc/redis/redis.conf \
-d redis redis-server /etc/redis/redis.conf

# 进入容器内
docker exec -it redis redis-cli

#设置持久化 设置aof类型的持久化方式
vim /root/app/redis/conf/redis.conf
appendonly yes
~~~



配置自动重启

~~~bash
[root@like conf]# docker update redis --restart=always
redis
[root@like conf]# docker update mysql --restart=always
mysql
~~~





## 4、创建后端项目

~~~
1.共同点
	jar包：web，openfeign
	包名：com.lk.mall.xxx
	
2.父项目
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.like.mall</groupId>
    <artifactId>mall</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>mall</name>
    <description>商城父项目</description>
    <packaging>pom</packaging>

    <modules>
        <module>mall-coupon</module>
        <module>mall-member</module>
        <module>mall-order</module>
        <module>mall-product</module>
        <module>mall-ware</module>
    </modules>

</project>

~~~

![image-20201024204508138](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201024204508.png)

## 5、创建数据库

![image-20201024205908619](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201024205908.png)



## 6、人人开源项目

后端

https://gitee.com/renrenio/renren-fast.git

前端

https://gitee.com/renrenio/renren-fast-vue.git

下载完成后启动

https://gitee.com/renrenio/renren-generator.git



## 7、生成代码

生成各个库的代码

![image-20201025132146646](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025132153.png)





# 分布式-微服务

在common中添加依赖

```xml
<!--    spring cloud alibaba-->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2.2.0.RELEASE</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```





## 1、服务发现-nacos

添加依赖

```xml
<!--nacos服务发现-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```



添加配置

```yml
spring:
  # 微服务
  cloud:
    nacos:
      # 注册地址
      discovery:
        server-addr:  47.112.150.204:8848
  application:
    name: mall-ware
```



启动nacos

~~~bash
cd /root/app/nacos/bin
sh startup.sh -m standalone	
~~~

![image-20201025144444822](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025144444.png)







## 2、服务远程调用-openfeign

==测试：member 远程调用coupon中的方法==

jar 包

```xml
<!--服务调用-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
    <version>2.1.3.RELEASE</version>
</dependency> 
```



**步骤：**

1.  编写==被调用服务的方法==

```java
@RestController
@RequestMapping("coupon/coupon")
public class CouponController {
    @Autowired
    private CouponService couponService;

    /**
 	* 测试 member 远程调用方法
 	* @return r
 	*/
   public R memberCoupons() {
        return R.ok().put("coupons","这里是coupons");
    }
```

2.  在调用端新建feign包

```java
package com.like.mall.member.feign;

import com.like.mall.common.utils.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;

/**
 * @author like
 * @since 2020-10-25 14:54
 * 远程调用 Coupon 服务中的方法
 */
@FeignClient("mall-coupon") // 要调用远程服务
public interface CouponFeignService {

    /**
     * 远程调用coupon 中的方法，调用地址为coupon服务中的完整调用地址
     */
    @GetMapping("coupon/coupon/member/list")
    public R memberCoupons();
}
```

3.  在调用端的启动类上添加注解

```java
@SpringBootApplication
@EnableDiscoveryClient // 开启服务发现
@EnableFeignClients(basePackages = "com.like.mall.member.feign") // 开启远程调用功能
public class MallMemberApplication {

    public static void main(String[] args) {
        SpringApplication.run(MallMemberApplication.class, args);
    }

}
```

4.调用远程服务

```java
@RestController
@RequestMapping("member/member")
public class MemberController {
    @Autowired
    private MemberService memberService;

    // 远程调用服务
    @Autowired
    private CouponFeignService couponFeignService;

    // 调运远程方法
    @RequestMapping("/coupon")
    public R testCoupon() {
        R r = couponFeignService.memberCoupons();
        return r;
    }
}
```

5.测试

![image-20201025151935968](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025151936.png)





## 3、配置中心-nacos

添加依赖

```xml
<!--nacos配置中心-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```





1.  新建bootstrap.properties文件

```properties
# 改名字，对应nacos里的配置文件名
spring.application.name=mall-coupon
# nacos配置中心地址
spring.cloud.nacos.config.server-addr=47.112.150.204:8848

my.name=like
```

2.  新建测试方法

```java
@RestController
@RequestMapping("coupon/coupon")
public class CouponController {
    @Autowired
    private CouponService couponService;
    // 从配置文件中获取
    @Value("${my.name}")
    private String myName;

    @GetMapping("/test/config")
    public R testConfigToNacos() {
        return R
                .ok()
                .put("user", myName);
    }
}
```

3.测试

![image-20201025154017545](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025154017.png)

4.在nacos中新建配置

mall-coupon.properties

![image-20201025154326882](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025154326.png)

5.  在controller中添加注解

```java
@RestController
@RequestMapping("coupon/coupon")
@RefreshScope // 动态刷新config
public class CouponController {
```

6、修改

![image-20201025155108154](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025155108.png)

![image-20201025155122283](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025155122.png)







### 指定多个配置文件

1.  新建一个命名空间
2.  新建3个配置文件
3.  注释掉application.yml中的配置信息

![image-20201025160704847](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025160704.png)

![image-20201025160654358](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025160654.png)

![image-20201025160755402](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025160755.png)

4.  查看coupro中是否加载了相关内容

![](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025160905.png)





## 4、网关- gateway

所有的请求先经过网关，比如常用的路转发，权限校验，限流控制等。==现在用gateway取代了zuul==



### 新建项目

1.依赖

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    <dependency>
        <groupId>com.like</groupId>
        <artifactId>mall-common</artifactId>
        <version>0.0.1-SNAPSHOT</version>
        <exclusions>
            <exclusion>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-web</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
</dependencies>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>Greenwich.SR3</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```



2.启动类

```java
@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)
@EnableDiscoveryClient
public class MallGatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(MallGatewayApplication.class, args);
    }

}
```



3.配置类

```yml
server:
  port: 88
spring:
  # 微服务
  cloud:
    # nacos
    nacos:
      # 服务发现
      discovery:
        server-addr: 47.112.150.204:8848
    # 网关
    gateway:
      routes:
        - id: test_go_baidu
          uri: https://www.baidu.com
          predicates:  # 断言规则
            - Query=url,baidu         # 携带参数url且值为baidu

        - id: test_go_qq
          uri: https://www.qq.com
          predicates:  # 断言规则
            - Query=url,qq           # 携带参数url且值为qq
  application:
    name: mall-gateway
```



```properties
# 改名字，对应nacos里的配置文件名
spring.application.name=mall-gateway
# nacos配置中心地址
spring.cloud.nacos.config.server-addr=47.112.150.204:8848
spring.cloud.nacos.config.namespace=8a868529-4b9e-4a77-833f-151532298809
```







# 商品服务

## a.分类维护

![image-20201101102120635](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101102120.png)

### 1.查询分类，组装层tree

查询数据库中的所有分类信息，组装成如图下列效果

![image-20201025171746015](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025171746.png)



**思路：**

1.  查找一标签：parentId = 0
2.  递归查找该标签的子标签：需要查找子标签的id = parentId



代码实现：

```java
// 添加属性  CategoryEntity

/**
* 在表中不存在，专门用来存放子节点
*/
@TableField(exist = false)
private List<CategoryEntity> children;


// controller 方法
@RestController
@RequestMapping("product/category")
public class CategoryController {
    @Autowired
    private CategoryService categoryService;

    /**
     * 查询分类中的所有信息，并组成的tree
     */
    @RequestMapping("/list/tree")
    public R list(@RequestParam Map<String, Object> params){
        List<CategoryEntity> entities = categoryService.listWithTree();

        return R.ok().put("data", entities);
    }
}




// service 方法
@Override
public List<CategoryEntity> listWithTree() {
    // 1.查出所有分类
    List<CategoryEntity> entities = baseMapper.selectList(null);
    // 2.组装成父子结构
    return entities
        .stream()
        .filter(c -> c.getParentCid() == 0)   // 查询到所有的一级分类，parent id = 0
        .map(c -> {
            c.setChildren(getChildren(c, entities)); // 查找当前标签的子标签
            return c;
        })
        .sorted((c1, c2) -> (c1.getSort() == null ? 0 : c1.getSort()) - (c2.getSort() == null ? 0 : c2.getSort())) // 排序
        .collect(Collectors.toList()); // 收集

}

/**
* 查找当前标签的子标签
*
* @param root 需要查找的标签
* @param all  所有标签
* @return 返回root的子标签集合
*/
private List<CategoryEntity> getChildren(CategoryEntity root, List<CategoryEntity> all) {
    return all
        .stream()
        .filter(categoryEntity -> categoryEntity.getParentCid() == root.getCatId())  // 条件：当all中的标签的父id是root的id
        .map(c -> {
            c.setChildren(getChildren(c, all)); // 递归查找，当前标签的子标签，比如说当前是2级标签，就查找他的子标签->3级标签
            return c;
        })
        .sorted((c1, c2) -> (c1.getSort() == null ? 0 : c1.getSort()) - (c2.getSort() == null ? 0 : c2.getSort())) // 排序
        .collect(Collectors.toList()); // 收集
}
```





### 2.把服务注册到gateway上

修改gateway服务的配置文件

```properties
server:
  port: 88
spring:
  # 微服务
  cloud:
    # nacos
    nacos:
      # 服务发现
      discovery:
        server-addr: 47.112.150.204:8848
    # 网关
    gateway:
      routes:
        - id: product_route
          uri: lb://mall-product
          predicates:
            - Path=/api/product/**
          filters:
            - RewritePath=/api/(?<segment>.*),/$\{segment}

        - id: third_party_route
          uri: lb://mall-coupon
          predicates:
            - Path=/api/coupon/**
          filters:
            - RewritePath=/api/(?<segment>.*),/$\{segment}

        - id: member_route
          uri: lb://mall-member
          predicates:
            - Path=/api/member/**
          filters:
            - RewritePath=/api/(?<segment>.*),/$\{segment}

        - id: ware_route
          uri: lb://mall-ware
          predicates:
            - Path=/api/ware/**
          filters:
            - RewritePath=/api/(?<segment>.*),/$\{segment}

        - id: admin_route
          uri: lb://renren-fast
          predicates:
            - Path=/api/**
          filters:
            - RewritePath=/api/(?<segment>.*),/renren-fast/$\{segment}


  application:
    name: mall-gateway
```



修改前端项目的请求地址

![image-20201025202653344](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201025202653.png)



这样直接访问88端口，通过特定域名访问特定服务





### 3.解决跨域

1.  gateway中添加配置类
2.  注释掉renren-fast中关于跨域的配置

```java
@Configuration
public class CorsConfig {

    @Bean
    public CorsWebFilter corsWebFilter() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        CorsConfiguration corsConfiguration = new CorsConfiguration();

        // 1.配置跨域
        corsConfiguration.addAllowedHeader("*");                // 请求头
        corsConfiguration.addAllowedMethod("*");               // 请求方法
        corsConfiguration.addAllowedOrigin("*");              // 请求来源
        corsConfiguration.setAllowCredentials(true);         // 是否允许携带cookie

        // 允许所有请求
        source.registerCorsConfiguration("/**",corsConfiguration);
        return new CorsWebFilter(source);
    }
}
```



### 4.前端页面搭建

人人开发平台配置页面：

![image-20201026124519382](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201026124526.png)

~~~
页面具体内容：
mall\mall-sys-vue\src\views\modules\product\category.vue
提交信息：
前端页面-商品系统-分页维护：页面搭建，添加添加和删除按钮逻辑（如果是一级标签就不显示删除只显示添加，如果还有子标签就不显示删除只显示添加）
~~~



### 5.后端删除和添加功能



#### 	删除

逻辑删除，使用mybatsi的逻辑删除功能

1.  product服务添加配置信息

![](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201026132702.png)

2.  给CategoryEntity实体类上的属性添加注解

    可以定义删除逻辑，和全局配置是反的

![image-20201026132851003](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201026132851.png)

3.  方法

```java
// controller
/**
 * 删除
 */
@PostMapping("/delete")
public R delete(@RequestBody Long[] catIds) {
    // 1.删除标签：检查是否被引用
    categoryService.removeMenu(Arrays.asList(catIds));
    return R.ok();
}


// service
@Override
public void removeMenu(List<Long> asList) {
    // TODO: 2020/10/26 1.删除标签：检查是否被引用
    // 现在使用逻辑删除
    baseMapper.deleteBatchIds(asList);
}
```





#### 添加

使用默认的save方法

![image-20201026214915071](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201026214922.png)



#### 编辑

使用默认的update方法





### 6.tree拖拽功能后端数据收集

目标节点的catLevel + deep小于3

需要考虑两种类型节点的catLevel，一种关系是：

如果是==同一个节点==下的==子节点的前后移动==，则不需要修改catLevel。

如果拖动到==与父节点平级的节点关系中==，则要将该拖动的节点的catLevel，设置为兄弟节点的Level，先考虑parentCid还是catLevel？

另外还有一种是前后拖动的情况，哪个范围最大？

肯定是拖动类型关系最大，

如果是前后拖动，则拖动后需要看待拖动节点的层级和设置拖动节点的parentId，

如果拖动节点和目标节点的层级相同，则任务是同级拖动，只需要修改节点的先后顺序，否则任务是跨级拖动，需要修改层级和重新设置parentId

同级拖动：

1.  判断节点和目标节点的catLevel是否相同相同则认为是同级拖动，
    1.  如果此时==移动后目标节点的parentId和待移动节点的相同==，移动类型是前后移动，只需要==修改sort==
    2.  否则需要修改catLevel和parentId和sort

前后移动：

1.  同级移动的标准是catLevel是否相同
2.  ==同级别==的前后移动分为parentId是否相同
    1.  parentId相同只需要修改sort即可
    2.  不同则需要修改parentId和sort
3.  ==不同级别==的前后移动
    1.  需要修改parentId,catLevel，sort

inner类型的移动：

1.  无论是同级inner，跨级inner，都需要修改parentId，catLevel，sort

哪种情况需要更新子节点

1.  拖拽的节点是否含有子节点
    1.  如果有子节点则需要更新子节点的catLevel，
    2.  如果待移动节点和目标节点额catLevel不同，则是跨级移动。如果是移动到父节点中，则需要设置catLevel，parentId和sort。
        1.  如果是移动到父节点中，则需要设置catLevel，parentId，sort





## b.品牌管理

![image-20201101102127978](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101102128.png)

使用逆向工程生成的代码

![image-20201028195029814](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201028195036.png)



![image-20201028202510341](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201028202510.png)







## c.文件存储-阿里云OSS

服务端签名后直传

1.  用户发送上传policy请求到服务器
2.  服务器返回上传policy和签名给用户
3.  用户直接上传数据给oss





新建模块：

1.  导入依赖

```xml
<dependencies>
        <!--		公共包-->
        <dependency>
            <groupId>com.like</groupId>
            <artifactId>mall-common</artifactId>
            <version>0.0.1-SNAPSHOT</version>
            <exclusions>
                <exclusion>
                    <!--        mybatis-->
                    <groupId>com.baomidou</groupId>
                    <artifactId>mybatis-plus-boot-starter</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <!--		oss sdk-->
        <!-- https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alicloud-oss -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alicloud-oss</artifactId>
            <version>2.2.0.RELEASE</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
```

2.  定义配置文件

```yml
spring:
  # 微服务
  cloud:
    # oss 上传文件信息
    alicloud:
      access-key: 
      secret-key: 
      oss:
        endpoint: oss-cn-shenzhen.aliyuncs.com
        bucket: mall-like
    nacos:
      server-addr: 
  application:
    name: mall-party

server:
  port: 13000
```

3.  编写控制层方法

```java
@RestController
public class OssController {

    @Autowired
    OSS ossClient;

    @Value("${spring.cloud.alicloud.oss.endpoint}")
    String endpoint;
    @Value("${spring.cloud.alicloud.oss.bucket}")
    String bucket;
    @Value("${spring.cloud.alicloud.access-key}")
    String accessId;
    @Value("${spring.cloud.alicloud.secret-key}")
    String accessKey;

    /**
     * 服务器签名
     *
     * @return 签名信息
     * @throws Exception 异常
     */
    @RequestMapping("/oss/policy")
    public Map<String, String> policy() throws Exception {
        //https://mall-like.oss-cn-shenzhen.aliyuncs.com/QQ%E6%88%AA%E5%9B%BE20201014092430.png
        String host = "https://" + bucket + "." + endpoint; // host的格式为 bucketname.endpoint
        // callbackUrl为 上传回调服务器的URL，请将下面的IP和Port配置为您自己的真实信息。
        String callbackUrl = "http://88.88.88.88:8888";
        String nowDate = new SimpleDateFormat("yyyy-MM-dd").format(new Date());
        String dir = nowDate + "/"; // 用户上传文件时指定的前缀。
        Map<String, String> respMap = null;
        try {
            long expireTime = 30;
            long expireEndTime = System.currentTimeMillis() + expireTime * 1000;
            Date expiration = new Date(expireEndTime);
            // PostObject请求最大可支持的文件大小为5 GB，即CONTENT_LENGTH_RANGE为5*1024*1024*1024。
            PolicyConditions policyConds = new PolicyConditions();
            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, 1048576000);
            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);

            String postPolicy = ossClient.generatePostPolicy(expiration, policyConds);
            byte[] binaryData = postPolicy.getBytes("utf-8");
            String encodedPolicy = BinaryUtil.toBase64String(binaryData);
            String postSignature = ossClient.calculatePostSignature(postPolicy);

            respMap = new LinkedHashMap<String, String>();
            respMap.put("accessid", accessId);
            respMap.put("policy", encodedPolicy);
            respMap.put("signature", postSignature);
            respMap.put("dir", dir);
            respMap.put("host", host);
            respMap.put("expire", String.valueOf(expireEndTime / 1000)); // 过期时间
            // respMap.put("expire", formatISO8601Date(expiration));


        } catch (Exception e) {
            // Assert.fail(e.getMessage());
            System.out.println(e.getMessage());
        } finally {
            ossClient.shutdown();
        }
        return respMap;
    }
}
```

4.  启动类加服务发现注解
5.  测试

![image-20201029202222371](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201029202229.png)



## d.品牌管理添加图片上传功能

#### 	1.图片上传组件

![image-20201030131053087](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201030131100.png)

```vue
// singleUpload
<template> 
  <div>
    <el-upload
      action="http://mall-like.oss-cn-shenzhen.aliyuncs.com"
      :data="dataObj"
      list-type="picture"
      :multiple="false" :show-file-list="showFileList"
      :file-list="fileList"
      :before-upload="beforeUpload"
      :on-remove="handleRemove"
      :on-success="handleUploadSuccess"
      :on-preview="handlePreview">
      <el-button size="small" type="primary">点击上传</el-button>
      <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过10MB</div>
    </el-upload>
    <el-dialog :visible.sync="dialogVisible">
      <img width="100%" :src="fileList[0].url" alt="">
    </el-dialog>
  </div>
</template>
<script>
   import {policy} from './policy'
   import { getUUID } from '@/utils'

  export default {
    name: 'singleUpload',
    // 用于父组件传入信息
    props: {
      value: String
    },
    computed: {
      imageUrl() {
        return this.value;
      },
      imageName() {
        if (this.value != null && this.value !== '') {
          return this.value.substr(this.value.lastIndexOf("/") + 1);
        } else {
          return null;
        }
      },
      fileList() {
        return [{
          name: this.imageName,
          url: this.imageUrl
        }]
      },
      showFileList: {
        get: function () {
          return this.value !== null && this.value !== ''&& this.value!==undefined;
        },
        set: function (newValue) {
        }
      }
    },
    data() {
      return {
        dataObj: {
          policy: '',
          signature: '',
          key: '',
          ossaccessKeyId: '',
          dir: '',
          host: '',
          // callback:'',
        },
        dialogVisible: false
      };
    },
    methods: {
      emitInput(val) {
        this.$emit('input', val)
      },
      handleRemove(file, fileList) {
        this.emitInput('');
      },
      handlePreview(file) {
        this.dialogVisible = true;
      },
      beforeUpload(file) {
        let _self = this;
        return new Promise((resolve, reject) => {
          policy().then(response => {
            _self.dataObj.policy = response.data.policy;
            _self.dataObj.signature = response.data.signature;
            _self.dataObj.ossaccessKeyId = response.data.accessid;
            _self.dataObj.key = response.data.dir +getUUID()+'_${filename}';
            _self.dataObj.dir = response.data.dir;
            _self.dataObj.host = response.data.host;
            resolve(true)
          }).catch(err => {
            reject(false)
          })
        })
      },
      handleUploadSuccess(res, file) {
        console.log("上传成功...")
        this.showFileList = true;
        this.fileList.pop();
        this.fileList.push({name: file.name, url: this.dataObj.host + '/' + this.dataObj.key.replace("${filename}",file.name) });
        this.emitInput(this.fileList[0].url);
      }
    }
  }
</script>
<style>

</style>
```



#### 	2.发送请求脚本

```js
import http from '@/utils/httpRequest.js'
export function policy() {
   return  new Promise((resolve,reject)=>{
     // 获取oss服务器签署信息
        http({
            url: http.adornUrl("/party/oss/policy"),
            method: "get",
            params: http.adornParams({})
        }).then(({ data }) => {
            resolve(data);
        })
    });
}
```

#### 	3.brand-add-or-update

添加上传组件

![image-20201030131157582](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201030131157.png)

#### 	4.brand

显示图片

![image-20201030131222220](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201030131222.png)

#### 	5.添加前端表单校验

![image-20201030132037258](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201030132037.png)

## e.添加统一个异常处理(数据校验)

定义一个异常处理类==@RestControllerAdvice==

```java
package com.like.mall.product.exception;
@Slf4j
@RestControllerAdvice(basePackages = "com.like.mall")
public class MallException {

    @ExceptionHandler(value = MethodArgumentNotValidException.class)
    public R handleValidationError(MethodArgumentNotValidException e) {
        log.error("数据校验出现问题：", e.getMessage(), e.getClass());
        Map<String, String> map = new HashMap<>();
        e
                .getBindingResult()
                .getFieldErrors()
                .forEach(fieldError -> {
                    map.put(fieldError.getField(), fieldError.getDefaultMessage());
                });
        return R.error(400,"数据校验出现问题").put("data",map);
    }

    @ExceptionHandler
    public R handleException(Throwable e) {
        return  R.error();
    }
}
```



在需要校验的实体类的==添加需要的注解==(使用jsr303规范)

![image-20201101090045777](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101090052.png)



在controller的接口上添加注解==@Valid==

![image-20201101090157295](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101090157.png)



## f.分组校验(数据校验)

~~~java
1.定义几个空实现的接口
	- // 数据校验 - 添加public interface Add {}
	-// 数据校验 - 修改public interface Update {}
2.在实体类上的校验注解中添加分组信息
    - 	@NotNull(message = "修改必须指定品牌id",groups = {Update.class})
		@Null(message = "添加不能指定品牌id",groups = {Add.class})
		private Long brandId;
	-   @NotBlank(message = "品牌名必须提交",groups = {Add.class,Update.class})
		private String name;
3.修改接口中的注解为@Valid->@Validated({Add.class})
~~~



## g.自定义jsr303校验注解

1.自定义校验注解

~~~java
package com.like.mall.common.valid;
@Documented
@Constraint(validatedBy = { ListValueConstraint.class}) // 通过什么校验器进行校验
@Target({METHOD,FIELD,ANNOTATION_TYPE,CONSTRUCTOR,PARAMETER,TYPE_USE}) // 可以标注在哪些属性上
@Retention(RUNTIME)
public @interface ListValue {

    // 错误信息
    String message() default "{com.like.mall.valid.common.ListValue.message";
    // 校验分组
    Class<?>[] groups() default {};
    //
    Class <? extends Payload> [] payload() default{};

    int[] ints() default { };
}
~~~

2.创建注解的校验器

~~~java
package com.like.mall.common.valid;
/**
 * @author like
 * @since 2020-11-01 9:43
 * ListValue的校验器
 * 思路：
 * 判断传入的值是否是ints里面的
 */

public class ListValueConstraint implements ConstraintValidator<ListValue, Integer> {

    private Set<Integer> set = new HashSet<Integer>();

    @Override
    public void initialize(ListValue constraintAnnotation) {
        // 添加到集合中
        int[] ints = constraintAnnotation.ints();
        for (int i : ints) {
            set.add(i);
        }
    }
    /**
     * 执行校验
     * @param value 需要校验的值
     */
    @Override
    public boolean isValid(Integer value, ConstraintValidatorContext context) {
        return set.contains(value);
    }
}
~~~

3.添加校验失败的默认信息

![image-20201101095922244](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101095922.png)

4.使用

```java
/**
 * 显示状态[0-不显示；1-显示]
 */
@ListValue(ints ={0,1}) // 自定义校验注解
private Integer showStatus;
```

5.测试

![image-20201101100124351](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101100124.png)







## h.SPU和SKU

SPU：(标准化单元产品) -==小米8==

是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息的集合，该==集合描述了一个产品的特性==

SKU：-==小米8 6+128G 黑色==

具体的产品的属性



![image-20201101101051507](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101101117.png)



## i.product库各表之间的联系

![image-20201101102104874](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101102104.png)

![image-20201101102316201](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101102316.png)

~~~java
attr:商品属性表
arrt_group：属性分组表
attr_attrgroup_relation:关联表
product_attr_value:商品对应的商品属性
~~~

![image-20201101102630897](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101102631.png)



![image-20201101102652387](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101102652.png)



## j.平台属性

导入sql文件

![image-20201101104826067](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101104826.png)

添加前端文件

![image-20201101104819122](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101104819.png)



### 1.获取指定分类属性分组

需求：

~~~
1.默认显示所有属性分组
2.点击分类，显示对应的属性分组
~~~

实现：

```java
/**
 * 商品系统-平台属性-属性分组
 * - 根据分类信息显示对应的分组信息
 * - 默认显示所有
 * -
 */
@RequestMapping("/list/{catelogId}")
public R list(@RequestParam Map<String, Object> params,
              @PathVariable Long catelogId) {
    PageUtils page= /*  attrGroupService.queryPage(params);*/
        attrGroupService.queryPage(params,catelogId);
    return R
        .ok()
        .put("page", page);
}


@Override
public PageUtils queryPage(Map<String, Object> params, Long catelogId) {

    IPage<AttrGroupEntity> page = null;
    // 默认显示所有
    if (catelogId == 0) {
        page = page(new Query<AttrGroupEntity>().getPage(params),
                    new QueryWrapper<AttrGroupEntity>());
    } else {
        // select * from pms_attr_group where catelog_id = ? and ( attr_group_id = key or attr_group_name  like "%key%"
        String key = (String) params.get("key"); // 获取参数中的key
        QueryWrapper<AttrGroupEntity> query = new QueryWrapper<AttrGroupEntity>().eq("catelog_id", catelogId);
        if (StringUtils.isNotBlank(key)) {
            query.and(o -> {
                o
                    .eq("attr_group_id", key)
                    .or()
                    .like("attr_group_name", key);
            });
        }
        page = page(new Query<AttrGroupEntity>().getPage(params), query);
    }
    return new PageUtils(page);
}
```

![image-20201101114208366](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101114208.png)





### 2.解决添加属性分组选择分类时子节点为空还显示选择的问题

CategoryEntity添加注解@JsonInclude(NON_EMPTY)

```java
/**
 * 在表中不存在，专门用来存放子节点
 */
@JsonInclude(NON_EMPTY) // 不为空的时候才返回
@TableField(exist = false)
private List<CategoryEntity> children;
```

![image-20201101122547550](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101122547.png)





### 3.修复点击修改的时候所属分类不能回显的问题

~~~
1.根据属性分组中的分类信息找到当前分类
2.递归查找它的父分类并保存
3.保存分类路径
4.AttrGroupEntity中添加属性
~~~

![image-20201101130936840](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101130936.png)

![image-20201101130648339](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101130648.png)

![image-20201101130713430](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101130713.png)

![image-20201101130509862](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101130510.png)



## k.添加mp分页插件

~~~java
package com.like.mall.product.config;
/**
 * @author like
 * @since 2020-11-01 13:13
 */
@Configuration
@EnableTransactionManagement
@MapperScan("com.like.mall.product.dao")
public class MybatisConfig {

    // 分页插件
    @Bean
    public PaginationInnerInterceptor paginationInnerInterceptor() {
        PaginationInnerInterceptor paginationInnerInterceptor = new PaginationInnerInterceptor();
        // 设置请求的页面大于最后页面的操作，true 返回首页
        paginationInnerInterceptor.setOverflow(true);
        // 设置最大分页
        paginationInnerInterceptor.setMaxLimit(500L);
        return paginationInnerInterceptor;
    }
}

~~~





## l.品牌管理:品牌和分类关联

~~~
pms_category_brand_relation
pms_brand
pms_category
~~~



1.获取当前品牌的分类

![image-20201101135911995](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101135912.png)

2.保存品牌和分类的关系

前端传入品牌和分类的id，后端获取对应的名字，关联起来

![image-20201101135945736](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201101135945.png)





3.级联修改

brand

![image-20201102125242614](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201102125249.png)



category

![](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201102125254.png)





## m.平台属性：规格参数

AttrController

### 1.添加规格参数的时候一起添加属性id和属性分组id

~~~~java
/**
 * 保存
 */
@RequestMapping("/save")
public R save(@RequestBody AttrVo attr){
    //        attrService.save(attr);
    // 保存attr 和 attr group 连接表
    attrService.saveAttr(attr);

    return R.ok();
}

@Override
@Transactional // 事务
public void saveAttr(AttrVo attr) {
    // 1.保存基本数据
    AttrEntity ae = new AttrEntity();
    BeanUtils.copyProperties(attr, ae);
    save(ae);
    // 2.保存关联关系
    AttrAttrgroupRelationEntity aarEntity = AttrAttrgroupRelationEntity
        .builder()
        .attrGroupId(attr.getAttrGroupId())
        //                .attrId(getByNameAndCatelogId(ae).getAttrId())
        .attrId(ae.getAttrId())
        .build();
    aarDao.insert(aarEntity);
}
~~~~



### 2.查询当前分类的属性

~~~
1.默认显示所有
2.点击分类显示对应的属性
3.参数名模糊查询
~~~



~~~java
/**
 * 查询当前分类的id
 */
@GetMapping("/base/list/{catelogId}")
public R baseAttrList(@RequestParam Map<String, Object> params,
                      @PathVariable("catelogId") Long catelogId) {
    PageUtils page = attrService.queryBaseAttrPage(params, catelogId);
    return R.ok()
        .put("page", page);
}

@Override
public PageUtils queryBaseAttrPage(Map<String, Object> params, Long catelogId) {
    QueryWrapper<AttrEntity> query = new QueryWrapper<>();
    // 1.组装查询条件
    if(catelogId != 0) {
        query.eq("catelog_id", catelogId);
    }
    String key = (String) params.get("key");
    if(StringUtils.isNotBlank(key)) {
        // attr_id attr_name
        query.and(q -> {
            q.eq("attr_id", key)
                .or()
                .like("attr_name", key);
        });
    }

    // 2.执行查询
    IPage<AttrEntity> page = page(new Query<AttrEntity>().getPage(params), query);

    // 3.封装返回
    PageUtils pageUtils = new PageUtils(page);
    List<AttrEntity> records = page.getRecords();
    List<AttrRespVo> attrRespVoList =
        records.stream()
        .map(attrEntity -> {
            AttrRespVo vo = new AttrRespVo();
            BeanUtils.copyProperties(attrEntity, vo);
            // 3.1.获取当前attr对应的分组信息
            AttrAttrgroupRelationEntity aare = aarDao.selectOne(
                // 查询属性分组组名和分类
                new QueryWrapper<AttrAttrgroupRelationEntity>().eq(
                    "attr_id",
                    vo.getAttrId()));
            if(aare != null) {
                AttrGroupEntity attrGroup = agDao.selectById(
                    aare.getAttrGroupId());
                vo.setGroupName(attrGroup.getAttrGroupName());
            }
            // 3.2.获取当前attr对应的分类信息
            CategoryEntity category = cDao.selectById(vo.getCatelogId());
            if(category != null) {
                vo.setCatelogName(category.getName());
            }
            return vo;
        })
        .collect(Collectors.toList());
    pageUtils.setList(attrRespVoList);
    return pageUtils;
}
~~~



![image-20201102212921698](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201102212928.png)





### 3.点击修改：添加回显信息（完整的分类路径）



```java
@Override
public AttrRespVo getAttrInfo(Long attrId) {
    AttrRespVo vo = new AttrRespVo();
    // 1.获取attr信息
    AttrEntity attr = getById(attrId);
    BeanUtils.copyProperties(attr, vo);

    // 2.获取分组信息
    AttrAttrgroupRelationEntity attrAttrgroupRelationEntity = aarDao.selectOne(
        new QueryWrapper<AttrAttrgroupRelationEntity>().eq("attr_id", attrId));
    if(attrAttrgroupRelationEntity != null) {
        vo.setAttrGroupId(attrAttrgroupRelationEntity.getAttrGroupId());
    }
    assert attrAttrgroupRelationEntity != null;
    AttrGroupEntity attrGroupEntity = agDao.selectById(attrAttrgroupRelationEntity.getAttrGroupId());
    if(attrGroupEntity != null) {
        vo.setGroupName(attrGroupEntity.getAttrGroupName());
    }

    // 3.获取分类完整路径
    Long[] catelogPath = categoryService.findCatelogPath(attr.getCatelogId());
    vo.setCatelogPath(catelogPath);
    return vo;
}
```





### 4.属性和属性分组联系的级联更新

```java
@Override
public void updateDetail(AttrVo attr) {
    AttrEntity attrE = new AttrEntity();
    BeanUtils.copyProperties(attr, attrE);
    // 1.先更新attr
    updateById(attrE);

    // 2.修改分组关联
    AttrAttrgroupRelationEntity relation =
            AttrAttrgroupRelationEntity.builder()
                                       .attrId(attr.getAttrId())
                                       .attrGroupId(attr.getAttrGroupId())
                                       .build();
    aarDao.update(relation, new QueryWrapper<AttrAttrgroupRelationEntity>().eq("attr_id", attr.getAttrId()));

}
```







## 平台属性-销售属性

### 获取销售信息方法：

> 由于和规格参数公用的是一张表，根据attrType来区别。所以公用一个查询当前分类属性的方法

修改url请求地址为动态的

```java
/**
 * 查询当前分类的属性（[0-销售属性，1-基本属性，2-既是销售属性又是基本属性]）
 */
@GetMapping("/{attrType}/list/{catelogId}")
public R baseAttrList(@RequestParam Map<String, Object> params,
                      @PathVariable("catelogId") Long catelogId,
                      @PathVariable String attrType) {
    PageUtils page = attrService.queryBaseAttrPage(params, catelogId,attrType);
    return R.ok()
            .put("page", page);
}
```

修改queryBaseAttrPage()方法，添加第三个值 attrType，添加查询条件

![image-20201104132858602](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201104132905.png)

添加判断，如果是基本属性就需要查询属性分组信息

![image-20201104132957712](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201104132957.png)

### 保存销售属性

> 如果是销售属性就不需要保存属性分组信息。

![image-20201104134756129](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201104134756.png)

### 销售属性数据回显

![image-20201104134818842](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201104134818.png)



### 修改销售属性

![image-20201104134828101](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201104134828.png)





## 商品系统-平台属性-属性分组



### 查询当前属性分组所关联的基本属性(规格参数)

~~~java
/**
 * 获取attrGroup所关联的分类信息
 *
 * @param attrGroupId attr组id
 *
 * @return {@link R}
 */
@GetMapping("/{attrGroupId}/attr/relation")
public R attrRelation(@PathVariable Long attrGroupId) {
    List<AttrEntity> attrs = attrService.getAttrGroupById(attrGroupId);

    return R.ok()
        .put("data", attrs);
}



@Override
public List<AttrEntity> getAttrGroupById(Long attrGroupId) {
    List<AttrAttrgroupRelationEntity> ens = aarDao.selectList(
        new QueryWrapper<AttrAttrgroupRelationEntity>().eq("attr_group_id", attrGroupId));
    // 收集所有id
    List<Long> ids =
        ens.stream()
        .map(AttrAttrgroupRelationEntity::getAttrId)
        .collect(Collectors.toList());

    return listByIds(ids);
}

~~~



### 删除属性分组和属性的关联关系

```java
/**
 * 删除属性分组和属性的关联关系
 *
 * @param vos 参数个数
 *
 * @return {@link R}
 */
@PostMapping("/attr/relation/delete")
public R delAttrAndAttrGroupRelation(@RequestBody List<AttrGroupRelationVo> vos) {
    Long count = attrGroupService.delAttrAndAttrGroupRelation(vos);
    return R.ok().put("count",count);
}


@Override
public Long delAttrAndAttrGroupRelation(List<AttrGroupRelationVo> vos) {
    List<AttrAttrgroupRelationEntity> entities =
        vos.stream()
        .map((vo) -> {
            AttrAttrgroupRelationEntity attrAttrgroupRelationEntity =
                AttrAttrgroupRelationEntity.builder()
                .build();
            BeanUtils.copyProperties(vo, attrAttrgroupRelationEntity);
            return attrAttrgroupRelationEntity;
        })
        .collect(Collectors.toList());
    return relationDao.delAttrAndAttrGroupRelation(entities);
}

<delete id="delAttrAndAttrGroupRelation">
    delete  from `mall-product`.`pms_attr_attrgroup_relation` where 
    <foreach collection="entities" item="item" separator=" or " open="(" close=")">
    (attr_id =#{item.attrId} and attr_group_id = #{item.attrGroupId})
    </foreach>
</delete>

```



### 查询出：当前分类，没有关联过分组的属性

~~~java
@GetMapping("/{attrGroupId}/noattr/relation")
public R attrNoRelation(@RequestParam Map<String, Object> params,
                        @PathVariable Long attrGroupId) {
    PageUtils page = attrService.getNoRelationAttr(params, attrGroupId);

    return R.ok().put("page", page);
}



@Override
public PageUtils getNoRelationAttr(Map<String, Object> params, Long attrGroupId) {
    // 1.当前分组只能关联自己所属的分类里面的所有属性
    AttrGroupEntity attrGroupEntity = agDao.selectById(attrGroupId);
    Long catelogId = attrGroupEntity.getCatelogId();

    // 2.当前分类中所有属性分组
    List<AttrGroupEntity> otherAttrGroup = agDao.selectList(new QueryWrapper<AttrGroupEntity>()
                                                            .eq(catelogId != null, "catelog_id", catelogId));
    List<Long> otherAttrGroupIds = otherAttrGroup.stream()
        .map(AttrGroupEntity::getAttrGroupId)
        .collect(Collectors.toList()); // 收集属性分组id

    // 3.这些分组所关联的属性
    List<AttrAttrgroupRelationEntity> relationEntities = attrAttrgroupRelationService.list(new QueryWrapper<AttrAttrgroupRelationEntity>()
                                                                                           .in(!otherAttrGroupIds.isEmpty(), "attr_group_id", otherAttrGroupIds));
    List<Long> attrIds = relationEntities.stream()
        .map(AttrAttrgroupRelationEntity::getAttrId)
        .collect(Collectors.toList()); // 收集关联过属性分组的属性
    // 4.查询出：当前分类，没有关联过分组的属性
    QueryWrapper<AttrEntity> queryWrapper = new QueryWrapper<AttrEntity>()
        .eq(catelogId != null, "catelog_id", catelogId)
        .notIn(!attrIds.isEmpty(), "attr_id", attrIds)  // 查询没有关联过属性分组的属性
        .eq("attr_type", ATTR_TYPE_BASE.getCode()); // 查询基本属性
    // 模糊查询
    String key = (String) params.get("key");
    if (StringUtils.isNotBlank(key)) {
        queryWrapper.and(query -> {
            query.eq("attr_id", key)
                .or()
                .like("attr_name", key);
        });
    }
    IPage<AttrEntity> page = page(new Query<AttrEntity>().getPage(params), queryWrapper);
    return new PageUtils(page);
}
~~~



### 保存属性分组和属性的关联关系



```java
/**
 * 添加属性和属性分组关系
 *
 * @param vos vos
 * @return {@link R}
 */
@PostMapping("/attr/relation")
public R addRelation(@RequestBody List<AttrGroupRelationVo> vos) {
    int count =  attrAttrgroupRelationService.saveAttrAndAttrGroupRrtion(vos);

    return R.ok();
}


@Override
public int saveAttrAndAttrGroupRrtion(List<AttrGroupRelationVo> vos) {
    List<AttrAttrgroupRelationEntity> entities = vos.stream().map(item -> {
        AttrAttrgroupRelationEntity aagr = AttrAttrgroupRelationEntity.builder().build();
        BeanUtils.copyProperties(item, aagr);
        return aagr;
    }).collect(Collectors.toList());
    saveBatch(entities);
    return entities.size();
}
```





## 商品系统-商品维护-发布商品





### 会员系统-获取所有会员等级

使用自动生成的接口

![image-20201107155055168](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201107155102.png)



### 获取当前分类所关联的品牌

```java
CategoryBrandRelationController
    /**
 * 获取分类关系品牌列表
 *
 * @param catId 分类id
 * @return {@link R}
 */
    @GetMapping("/brands/list")
    public R catRelationBrandList(@RequestParam(required = true) Long catId) {
    List<BrandEntity> entities = categoryBrandRelationService.getBrandsByCatId(catId);

    List<BrandVo> brandVos = entities.stream()
        .map(i -> BrandVo.builder()
             .brandName(i.getName())
             .brandId(i.getBrandId())
             .build())
        .collect(Collectors.toList());
    return R.ok().put("data",brandVos);
}



@Override
public List<BrandEntity> getBrandsByCatId(Long catId) {
    // 1.查询出和当前分类项关联的品牌id
    List<CategoryBrandRelationEntity> categoryBrandRelationEntities = categoryBrandRelationService
        .list(new QueryWrapper<CategoryBrandRelationEntity>()
              .eq("catelog_id", catId));
    // 2.根据上面的list选出品牌id
    List<Long> brandIdList = categoryBrandRelationEntities.stream()
        .map(CategoryBrandRelationEntity::getBrandId).collect(Collectors.toList());

    // 3.根据brandId查找brand
    return brandService.listByIds(brandIdList);
}
```





### 获取分类下所有属性分组，关联属性

```java
AttrGroupController
    @GetMapping("/{catelogId}/withattr")
    public R getAttrGroupAndAttrByCatId(@PathVariable Long catelogId) {
    // 1.查询当前分类下所有属性分组
    List<AttrGroupAndAttrVo> vos = attrGroupService.getAttrGroupAndAttrByCatId(catelogId);
    return R.ok().put("data", vos);
}



@Override
public List<AttrGroupAndAttrVo> getAttrGroupAndAttrByCatId(Long catelogId) {
    // 1、查询所有分组
    List<AttrGroupEntity> attrGroup = list(new QueryWrapper<AttrGroupEntity>()
                                           .eq("catelog_id", catelogId));

    return attrGroup.stream()
        .map(i -> {
            AttrGroupAndAttrVo vo = new AttrGroupAndAttrVo();
            BeanUtils.copyProperties(i, vo);
            // 2、根据分组id查询所有属性
            List<AttrEntity> attrs = attrService.getAttrGroupById(vo.getAttrGroupId());
            vo.setAttrs(attrs);
            return vo;
        })
        .collect(Collectors.toList());
}
```



### 保存spu信息 -复杂（远程调用）

#### SpuInfoController.save

```java
/**
 * 保存
 */
@PostMapping("/save")
public R save(@RequestBody SpuSaveVo vo){
    spuInfoService.saveSpuInfo(vo);

    return R.ok();
}
```



#### spuInfoService.saveSpuInfo

```java
@Override
@Transactional
public void saveSpuInfo(SpuSaveVo vo) {
    // 1.保存spu基本信息 spu_info
    SpuInfoEntity spuInfo = new SpuInfoEntity();
    BeanUtils.copyProperties(vo, spuInfo);
    spuInfo.setCreateTime(new Date());
    spuInfo.setUpdateTime(new Date());
    this.saveBaseSpuInfo(spuInfo);

    // 2.保存spu描述图片 spu_info_desc
    List<String> decript = vo.getDecript();
    SpuInfoDescEntity spuInfoDesc = new SpuInfoDescEntity();
    spuInfoDesc.setSpuId(spuInfo.getId());
    spuInfoDesc.setDecript(String.join(",", decript));
    spuInfoDescService.saveSpuInfoDesc(spuInfoDesc);

    // 3.保存spu图片集   spu_images
    List<String> images = vo.getImages();
    spuImagesService.saveImages(spuInfo.getId(), images);

    // 4.保存spu规格参数 product_attr_value
    List<BaseAttrs> baseAttrs = vo.getBaseAttrs();
    List<ProductAttrValueEntity> productAttrValueEntities = baseAttrs.stream()
        .map(i -> {
            AttrEntity attr = attrService.getById(i.getAttrId());
            return ProductAttrValueEntity.builder()
                .attrId(i.getAttrId())
                .attrName(attr.getAttrName())
                .attrValue(i.getAttrValues())
                .quickShow(i.getShowDesc())
                .spuId(spuInfo.getId())
                .build();
        }).collect(Collectors.toList());
    productAttrValueService.saveProductAttrValueEntities(productAttrValueEntities);

    // 5.保存spu的积分信息  跨库：  mall-sale spu_bounds
    Bounds bounds = vo.getBounds();
    // product 要给 coupon 发送数据 -> To:SpuBoundTo,创建于公共包common中
    SpuBoundTo spuBoundTo = new SpuBoundTo();
    BeanUtils.copyProperties(bounds, spuBoundTo);
    spuBoundTo.setSpuId(spuInfo.getId());
    R saveSpuBounds = couponFeignService.saveSpuBounds(spuBoundTo);
    if (saveSpuBounds.getCode() != 0) {
        log.error("远程调用coupon服务失败{}(saveSpuBounds):" + spuBoundTo);
    }

    // 6.保存spu对应的sku信息
    List<Skus> skus = vo.getSkus();
    if (!skus.isEmpty()) {
        skus.forEach(sku -> {
            // - sku基本信息 sku_info
            SkuInfoEntity skuInfo = new SkuInfoEntity();
            BeanUtils.copyProperties(sku, skuInfo);
            skuInfo.setBrandId(spuInfo.getBrandId());
            skuInfo.setCatalogId(spuInfo.getCatalogId());
            skuInfo.setSaleCount(0L);
            skuInfo.setSpuId(spuInfo.getId());
            String defaultImg = "";
            for (Images image : sku.getImages()) {
                if (image.getDefaultImg() == 1) {
                    defaultImg = image.getImgUrl();
                }
            }
            skuInfo.setSkuDefaultImg(defaultImg);
            skuInfoService.saveSkuInfo(skuInfo);

            // - sku图片信息 sku_images
            Long skuId = skuInfo.getSkuId();
            List<SkuImagesEntity> skuImages = sku.getImages().stream()
                .map(i -> {
                    SkuImagesEntity skuImage = new SkuImagesEntity();
                    skuImage.setSkuId(skuId);
                    skuImage.setImgUrl(i.getImgUrl());
                    skuImage.setDefaultImg(i.getDefaultImg());
                    return skuImage;
                }).filter(e -> !e.getImgUrl().isEmpty())
                .collect(Collectors.toList());
            skuImagesService.saveBatch(skuImages);

            // - sku销售属性信息 sku_sal_attr_value
            List<SkuSaleAttrValueEntity> skuSaleAttrValueEntities = sku.getAttr().stream().map(a -> {
                SkuSaleAttrValueEntity skuSaleAttrValue = new SkuSaleAttrValueEntity();
                BeanUtils.copyProperties(a, skuSaleAttrValue);
                skuSaleAttrValue.setSkuId(skuId);
                return skuSaleAttrValue;
            }).collect(Collectors.toList());
            skuSaleAttrValueService.saveBatch(skuSaleAttrValueEntities);

            // - sku优惠满减信息 跨库：mall-sale sms_sku_ladder sms_sku_full_reduction sms_spu_bounds
            SkuReductionTo skuReductionTo = new SkuReductionTo();
            BeanUtils.copyProperties(sku, skuReductionTo);
            skuReductionTo.setSkuId(skuId);
            if (skuReductionTo.getFullCount() <= 0 || skuReductionTo.getFullPrice().compareTo(new BigDecimal(0)) > 0) {
                R saveSkuReduction = couponFeignService.saveSkuReduction(skuReductionTo);
                if (saveSkuReduction.getCode() != 0) {
                    log.error("远程调用coupon服务失败{}(saveSkuReduction):" + skuReductionTo);
                }
            }

        });
    }
}
```



#### this.saveBaseSpuInfo

```java
@Override
public void saveBaseSpuInfo(SpuInfoEntity spuInfo) {
    baseMapper.insert(spuInfo);
}
```



#### spuInfoDescService.saveSpuInfoDesc

```java
@Override
public void saveSpuInfoDesc(SpuInfoDescEntity spuInfoDesc) {
        baseMapper.insert(spuInfoDesc);
}
```



#### spuImagesService.saveImages

```java
@Override
public void saveImages(Long id, List<String> images) {
    if (!images.isEmpty()) {
        List<SpuImagesEntity> spuImages = images.stream()
                .map(i -> {
                    SpuImagesEntity spuImage = new SpuImagesEntity();
                    spuImage.setId(id);
                    spuImage.setImgUrl(i);
                    return spuImage;
                }).collect(Collectors.toList());
        saveBatch(spuImages);
    }
}
```



#### productAttrValueService.saveProductAttrValueEntities

```java
@Override
public void saveProductAttrValueEntities(List<ProductAttrValueEntity> productAttrValueEntities) {
    saveBatch(productAttrValueEntities);
}
```



#### 远程调用-保存spu积分信息

```java
/**
 * 调用远程coupon服务保存spu积分信息
 *
 * @param spuBoundTo spu积分TO
 * @return {@link R}
 */
@PostMapping("/coupon/spubounds/save")
R saveSpuBounds(@RequestBody SpuBoundTo spuBoundTo);



/**
 * 保存
 */
@PostMapping("/save")
public R save(@RequestBody SpuBoundsEntity spuBounds){
    spuBoundsService.save(spuBounds);

    return R.ok();
}
```



#### 保存sku-skuInfoService.saveSkuInfo

```java
@Override
public void saveSkuInfo(SkuInfoEntity skuInfo) {
    save(skuInfo);
}
```



#### 保存sku-skuImagesService.saveBatch

```java
skuImagesService.saveBatch(skuImages);
```

​	

#### 保存sku-skuSaleAttrValueService.saveBatch

```java
skuSaleAttrValueService.saveBatch(skuSaleAttrValueEntities);
```



#### 远程调用-保存sku详细信息

```java
@PostMapping("/coupon/skufullreduction/saveinfo")
R saveSkuReduction(@RequestBody SkuReductionTo skuReductionTo);

/**
 * 列表
 */
@PostMapping("/saveinfo")
public R saveInfo(@RequestBody SkuReductionTo skuReductionTo) {
    skuFullReductionService.saveSkuReduction(skuReductionTo);
    return R.ok();
}



@Override
public void saveSkuReduction(SkuReductionTo skuReductionTo) {
    // - sku优惠满减信息 跨库：mall-sale sms_sku_ladder sms_sku_full_reduction sms_member_price
    SkuLadderEntity skuLadder = new SkuLadderEntity();
    skuLadder.setSkuId(skuReductionTo.getSkuId());
    skuLadder.setFullCount(skuReductionTo.getFullCount());
    skuLadder.setDiscount(skuReductionTo.getDiscount());
    skuLadder.setAddOther(skuReductionTo.getCountStatus());
    //        skuLadder.setPrice();
    if (skuLadder.getFullCount() > 0) skuLadderService.save(skuLadder);

    SkuFullReductionEntity skuFullReduction = new SkuFullReductionEntity();
    BeanUtils.copyProperties(skuReductionTo, skuFullReduction);
    if (skuFullReduction.getFullPrice().compareTo(new BigDecimal(0)) > 0)
        this.save(skuFullReduction);

    List<MemberPriceEntity> memberPriceEntityList = skuReductionTo.getMemberPrice().stream()
        .map(item -> {
            MemberPriceEntity memberPriceEntity = new MemberPriceEntity();
            memberPriceEntity.setSkuId(skuReductionTo.getSkuId());
            memberPriceEntity.setMemberLevelId(item.getId());
            memberPriceEntity.setMemberLevelName(item.getName());
            memberPriceEntity.setMemberPrice(item.getPrice());
            memberPriceEntity.setAddOther(1);
            return memberPriceEntity;
        })
        .filter(i-> i.getMemberPrice().compareTo(new BigDecimal(0)) > 0)
        .collect(Collectors.toList());
    memberPriceService.saveBatch(memberPriceEntityList);
}
```





### spu管理：spu搜索



```java
SpuInfoController
    /**
 * 列表
 */
    @RequestMapping("/list")
    public R list(@RequestParam Map<String, Object> params){
    PageUtils page = spuInfoService.queryPageByCondition(params);

    return R.ok().put("page", page);
}

@Override
public PageUtils queryPageByCondition(Map<String, Object> params) {
    QueryWrapper<SpuInfoEntity> query = new QueryWrapper<>();
    String key = (String) params.get("key");
    if (StringUtils.isNotBlank(key)) {
        query.and(q -> {
            q.eq("id", key).or().like("spu_name", key);
        });
    }
    queryCondition(query, params, "status", "publish_status");
    queryCondition(query, params, "branId", "brand_id");
    queryCondition(query, params, "catelogId", "catelog_id");


    IPage<SpuInfoEntity> page = this.page(
        new Query<SpuInfoEntity>().getPage(params),
        query
    );
    return new PageUtils(page);

}

public void queryCondition(QueryWrapper<SpuInfoEntity> query, Map<String, Object> params, String key, String colName) {
    String status = (String) params.get(key);
    if (StringUtils.isNotBlank(status)) {
        query.and(q -> {
            q.eq(colName, status);
        });
    }
}
```



### 商品系统：商品管理-sku搜索

```java
@Override
public PageUtils queryPageByCondition(Map<String, Object> params) {
    QueryWrapper<SkuInfoEntity> query = new QueryWrapper<>();
    // 1、name
    String key = (String) params.get("key");
    if (StringUtils.isNotBlank(key)) {
        query.and(q -> {
            q.eq("sku_id", key).or().like("sku_name", key);
        });
    }
    String catalogId = (String) params.get("catelogId");
    if (StringUtils.isNotBlank(catalogId) && !"0".equalsIgnoreCase(catalogId)) {
        query.eq("catalog_id", catalogId);
    }

    queryCondition(query, params, "branId", "brand_id");

    // 2、范围
    rangeMin(params, query);
    rangeMax(params, query);

    IPage<SkuInfoEntity> page = this.page(
            new Query<SkuInfoEntity>().getPage(params),
            query
    );

    return new PageUtils(page);
}

public void queryCondition(QueryWrapper<SkuInfoEntity> query, Map<String, Object> params, String key, String colName) {
    String status = (String) params.get(key);
    if (StringUtils.isNotBlank(status)) {
        query.and(q -> {
            q.eq(colName, status);
        });
    }
}

public void rangeMax(Map<String, Object> params, QueryWrapper<SkuInfoEntity> query) {
    String max = (String) params.get("max");
    if (StringUtils.isNotBlank(max)) {
        BigDecimal bigDecimal = new BigDecimal(max);
        if (bigDecimal.compareTo(new BigDecimal(0)) > 0)
            query.le("price", max);
    }
}

public void rangeMin(Map<String, Object> params, QueryWrapper<SkuInfoEntity> query) {
    String min = (String) params.get("min");
    if (StringUtils.isNotBlank(min)) {
        BigDecimal bigDecimal = new BigDecimal(min);
        if (bigDecimal.compareTo(new BigDecimal(0)) > 0)
            query.ge("price", min);
    }
}
```





# 库存系统

## 仓库维护：搜索功能

```java
@Override
public PageUtils queryPage(Map<String, Object> params) {
    QueryWrapper<WareInfoEntity> query = new QueryWrapper<>();
    String key = (String) params.get("key");
    if (StringUtils.isNotBlank(key)) {
        query.eq("id",key)
                .or().like("name",key)
                .or().like("address",key)
                .or().like("areacode",key);
    }
    IPage<WareInfoEntity> page = this.page(
            new Query<WareInfoEntity>().getPage(params),
            query
    );

    return new PageUtils(page);
}
```





## 商品库存-搜索

```java
@Override
public PageUtils queryPage(Map<String, Object> params) {
    QueryWrapper<WareSkuEntity> query = new QueryWrapper<>();
    String skuId = (String) params.get("skuId");
    if (StringUtils.isNotBlank(skuId)) {
        query.eq("sku_id",skuId);

    }
    String wareId = (String) params.get("wareId");
    if (StringUtils.isNotBlank(wareId)) {
        query.eq("ware_id",wareId);

    }
    IPage<WareSkuEntity> page = this.page(
            new Query<WareSkuEntity>().getPage(params),
            query
    );

    return new PageUtils(page);
}
```



## 采购单维护

### 搜索

```java
@Override
public PageUtils queryPage(Map<String, Object> params) {
    QueryWrapper<PurchaseDetailEntity> query = new QueryWrapper<>();

    String key = (String) params.get("key");
    if (StringUtils.isNotBlank(key)) {
        query.and(q -> {
            q.eq("purchase_id", key).or().eq("sku_id", key);
        });
    }
    String status = (String) params.get("status");
    if (StringUtils.isNotBlank(status)) {
        query.eq("status", status);
    }
    String wareId = (String) params.get("wareId");
    if (StringUtils.isNotBlank(wareId)) {
        query.eq("ware_id", wareId);
    }

    IPage<PurchaseDetailEntity> page = this.page(
            new Query<PurchaseDetailEntity>().getPage(params),
            query
    );

    return new PageUtils(page);
}
```





### 采购单合并-查询没有被分配的采购单

![image-20201108173836076](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201108173843.png)





```java
@RequestMapping("/unreceive/list")
public R unclaimedList(@RequestParam Map<String, Object> params) {
    PageUtils page = purchaseService.queryPageUnreceive(params);

    return R.ok().put("page", page);
}


@Override
public PageUtils queryPageUnreceive(Map<String, Object> params) {
    IPage<PurchaseEntity> page = this.page(
        new Query<PurchaseEntity>().getPage(params),
        new QueryWrapper<PurchaseEntity>()
        .eq("status",0).or().eq("status",1)
    );

    return new PageUtils(page);

}
```



### 合并采购需求

```java
/**
* 合并采购需求单到采购单
*
* @param vo vo
* @return {@link R}
*/
@PostMapping("/merge")
public R merge(@RequestBody MergeVo vo) {
    purchaseService.merge(vo);
    return R.ok();
}


@Override
public void merge(MergeVo vo) {
    Long purchaseId = vo.getPurchaseId();
    if (purchaseId == null) {
        // 1.没有采购单就新建一个
        PurchaseEntity purchaseEntity = new PurchaseEntity();
        purchaseEntity.setStatus(WareConstant.Purchase.create); // 采购单的状态为新建
        purchaseEntity.setCreateTime(new Date());
        purchaseEntity.setUpdateTime(new Date());
        this.save(purchaseEntity);
        purchaseId = purchaseEntity.getId();
    }
    // 2.修改采购需求单的id和状态
    List<Long> items = vo.getItems();
    Long finalPurchaseId = purchaseId;
    List<PurchaseDetailEntity> purchaseDetailEntities = items.stream()
        .map(i -> {
            PurchaseDetailEntity purchaseDetail = new PurchaseDetailEntity();
            purchaseDetail.setId(i);
            purchaseDetail.setPurchaseId(finalPurchaseId);
            purchaseDetail.setStatus(WareConstant.PurchaseDetail.assigned);  // 修改采购需求单的状态为已分配
            return purchaseDetail;
        }).collect(Collectors.toList());

    purchaseDetailService.updateBatchById(purchaseDetailEntities);
}

```



### 采购员领取采购单

```java
PurchaseController
/**
 * 采购员领取采购单
 *
 * @param ids id
 * @return {@link R}
 */
@PostMapping("/received")
public R received(@RequestBody List<Long> ids) {
    purchaseService.received(ids);
    return R.ok();
}


@Override
@Transactional
public void received(List<Long> ids) {
    // 1.修改采购单的状态（刚创建或者刚分配）
    List<PurchaseEntity> receiveList = list(new QueryWrapper<PurchaseEntity>().in("id", ids)).stream()
        .filter(i -> i.getStatus() == WareConstant.Purchase.create || i.getStatus() == WareConstant.Purchase.assigned)
        .peek(i -> {
            i.setStatus(WareConstant.Purchase.receive);
            i.setUpdateTime(new Date());
        })
        .collect(Collectors.toList());

    // 2.改变采购单的状态
    updateBatchById(receiveList);

    // 3.改变采购需求单的状态
    receiveList.forEach(i -> {
        List<PurchaseDetailEntity> purchaseDetailEntities = purchaseDetailService.updateStatusByPurchaseId(i.getId()).stream()
            .map(item -> {
                PurchaseDetailEntity purchaseDetail = new PurchaseDetailEntity();
                purchaseDetail.setId(item.getId());
                purchaseDetail.setStatus(WareConstant.PurchaseDetail.buying); // 修改为采购中
                return purchaseDetail;
            }).collect(Collectors.toList());
        purchaseDetailService.updateBatchById(purchaseDetailEntities);
    });
}
```



### 完成采购

```java
/**
 * 完成采购
 *
 * @param vos vos
 * @return {@link R}
 */
@PostMapping("/done")
public R finish(@RequestBody PurchaseDoneVo vos) {
    purchaseService.done(vos);
    return R.ok();
}

@Override
@Transactional
public void done(PurchaseDoneVo vos) {
    // 1.改变采购项的状态
    boolean flag = true;
    List<PurchaseItemDoneVo> items = vos.getItems();
    List<PurchaseDetailEntity> needUpdates = new ArrayList<>();
    for (PurchaseItemDoneVo item : items) {
        PurchaseDetailEntity purchaseDetail = new PurchaseDetailEntity();
        if (item.getStatus() == WareConstant.PurchaseDetail.hasError) {
            flag = false;
            purchaseDetail.setStatus(WareConstant.PurchaseDetail.hasError);
        } else {
            purchaseDetail.setStatus(WareConstant.PurchaseDetail.finish);

            // 3.将成功的采购单数据入库
            PurchaseDetailEntity purchaseDetails = purchaseDetailService.getById(item.getItemId());
            wareSkuService.addStock(purchaseDetails.getSkuId(),purchaseDetails.getWareId(),purchaseDetails.getSkuNum());
        }
        purchaseDetail.setId(item.getItemId());
        needUpdates.add(purchaseDetail);
    }
    purchaseDetailService.updateBatchById(needUpdates);

    // 2.改变采购单状态
    Long id = vos.getId();
    PurchaseEntity purchase = new PurchaseEntity();
    purchase.setId(id);
    purchase.setStatus(flag ? WareConstant.Purchase.finish:WareConstant.Purchase.hasError);
    purchase.setUpdateTime(new Date());
    purchaseService.updateById(purchase);
}
```

### spu规格维护

获取spu的基本属性

```java
@GetMapping("/base/listforspu/{spuId}")
public R baseAttrList(@PathVariable String spuId) {
    List<ProductAttrValueEntity> list=  productAttrValueService.baseAttrList(spuId);

    return R.ok().put("data",list);
}

@Override
public List<ProductAttrValueEntity> baseAttrList(String spuId) {
    return list(new QueryWrapper<ProductAttrValueEntity>()
                .eq("spu_id", spuId));

}
```





修改规格信息

```java
AttrController

/**
* 更新spu基本属性（规格参数）
*
* @param spuId spu id
* @param vos   vos
* @return {@link R}
*/
@PostMapping("/update/{spuId}")
public R updateSpuBaseAttr(@PathVariable Long spuId,
@RequestBody List<ProductAttrValueEntity> vos) {
productAttrValueService.updateSpuBaseAttr(spuId,vos);

return R.ok().put("data", list);

}


@Override
@Transactional
public void updateSpuBaseAttr(Long spuId, List<ProductAttrValueEntity> vos) {
// 1.删除以前的数据
remove(new QueryWrapper<ProductAttrValueEntity>().eq("spu_id",spuId));

// 2.保存
List<ProductAttrValueEntity> collect = vos.stream()
.peek(i -> i.setSpuId(spuId)).collect(Collectors.toList());
saveBatch(collect);
}
```