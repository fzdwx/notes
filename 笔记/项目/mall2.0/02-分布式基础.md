# 1.什么是分布式架构

- 不同的业务(功能模块)分散部署在不同的服务器
- 每个子系统负责一个或多个不同的业务模块
- 服务之间可以相互交互通信



> 缺点：

- 架构复杂
- 部署多个子系统复杂
- 系统之间通信耗时



> 设计原则

- 异步解耦
- 幂等性
- 拆分原则
- 融合分布式中间件





# 2.Redis的线程模型

阻塞和非阻塞

![image-20210303153714595](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20210303153714.png)





# 3.项目优化：首页轮播图使用redis缓存



~~~
思路：
	1.请求接口的时候先从redis中获取key对应的value
	2.不存在就从db中查询，然后保存到redis中作为缓存
问题：如果轮播图发生修改怎么办？
	1.后台运营系统，一旦发生更改，就可以删除缓存，然后重置缓存
	2.定时重置，清除缓存的时候尽量分开，避免缓存雪崩
~~~



```java
@GetMapping("carousel")
@ApiOperation(value = "获取首页轮播图列表")
public HttpJSONResult carousel() {
    List<Carousel> dbDataList = null;
    // 1.先从redis中获取缓存
    String redisCacheJson = redisUtil.get(REDIS_KEY_CAROUSEL);
    // 2.判断是否有缓存
    if (StringUtils.isBlank(redisCacheJson)) {
        dbDataList = carouselService.queryAllRootLevelCat(YesOrNo.YES.code);
        // 第一次查询，保存一份到redis中作为缓存
        redisUtil.set(REDIS_KEY_CAROUSEL, JsonUtils.objectToJson(dbDataList));
    } else dbDataList = JsonUtils.jsonToList(redisCacheJson, Carousel.class);

    return HttpJSONResult.ok(dbDataList);
}
```



# 4.购物车功能：将数据保存在redis中

~~~
思路：
	1.先从redis中获取该用户的购物车信息
	2.循环购物车，如果有前端传入的商品信息
	3.如果该商品存在，就添加对应的购买数量
	4.如果不存在，就添加商品
	5.如果购物车都存在，就新建购物车，然后添加商品
~~~



```java
@PostMapping("/add")
@ApiOperation(value = "添加商品到购物车")
public HttpJSONResult add(
    @RequestParam String userId,
    @RequestBody ShopCartBO shopCart) {
    if (StrUtil.isBlank(userId)) return HttpJSONResult.errorMsg("user Id 不能为空");
    log.info("购物车数据:{}", shopCart);
    List<ShopCartBO> shopCartList = null;

    // 前端用户在登录的时候，添加商品上购物车，会同时在后端同步购物车到redis中
    String shopCartRedisCacheJson = redisUtil.get(REDIS_KEY_SHOP_CART_PREFIX + userId);
    if (StringUtils.isNotBlank(shopCartRedisCacheJson)) {
        AtomicBoolean isHaving = new AtomicBoolean(false);
        // 1.判断添加到购物车的商品在购物车中是否存在，如果存在就累加数量
        shopCartList = JsonUtils.jsonToList(shopCartRedisCacheJson, ShopCartBO.class).stream().peek((cart) -> {
            if (cart.getSpecId().equals(shopCart.getSpecId())) {
                cart.setBuyCounts(cart.getBuyCounts() + shopCart.getBuyCounts());
                isHaving.set(true);
            }
        }).collect(Collectors.toList());
        // 2.不存在就添加到购物车中
        if (!isHaving.get()) {
            shopCartList.add(shopCart);
        }
    } else {
        // 3.用户第一次，新建购物车
        shopCartList = new ArrayList<>();
        shopCartList.add(shopCart);
    }
    // 4.覆盖原有购物车
    redisUtil.set(REDIS_KEY_SHOP_CART_PREFIX + userId, JsonUtils.objectToJson(shopCartList));

    return HttpJSONResult.ok();
}
```