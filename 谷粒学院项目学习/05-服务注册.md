>   依赖

```xml
<!--Spring Cloud-->
<dependency>
   <groupId>org.springframework.cloud</groupId>
   <artifactId>spring-cloud-dependencies</artifactId>
   <version>Hoxton.SR1</version>
   <type>pom</type>
   <scope>import</scope>
</dependency>
<dependency>
   <groupId>com.alibaba.cloud</groupId>
   <artifactId>spring-cloud-alibaba-dependencies</artifactId>
   <version>2.1.0.RELEASE</version>
   <type>pom</type>
   <scope>import</scope>
</dependency>
```



# 一、Nacos注册中心

==Naming Configuration Service==

**注册**

在service中添加依赖

```xml
<!--服务注册-->
<dependency>
   <groupId>com.alibaba.cloud</groupId>
   <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

在配置文件中添加配置

```yml
#spring
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #nacos地址
```

在应用启动类添加注解

```
@EnableDiscoveryClient
```



![image-20201014163119669](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201014163119.png)





# 二、OpenFeign 服务调用

>   依赖

消费者中引用，但是service可能会相互调用就在最大的里面配置

```xml
<!--服务调用-->
<dependency>
   <groupId>org.springframework.cloud</groupId>
   <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

>   配置

在edu里面添加注解

```
@EnableFeignClients
```



## 1.测试edu和oss通过nacos联调



1.在oss服务中添加del方法-FileController

![image-20201014171602090](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201014171602.png)



2.在edu服务中添加feign包

![image-20201014171747498](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201014171747.png)



3.在edu服务中的控制层添加测试方法-TeacherController

![image-20201014171816577](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201014171816.png)



4.测试

使用swaager发送请求： http://localhost:8888/admin/edu/teacher/test

![image-20201014171925758](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201014171925.png)



## 2.负载均衡

![image-20200827205910371](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20200827205917.png)

```yml
service-oss: #被调用着的服务名称
  ribbon:
    NFloadBalancerRuleCalssName: com.netflix.loadbalancer.RandomRule
```



>   启动两个oss服务

调用edu的testOpenFeign方法，可以看到默认是轮询的访问方法

![image-20201014173959472](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201014173959.png)

![image-20201014174006296](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20201014174006.png)



## 3.OpenFeign的超时控制

```properties
#oss设置-ribbon     被调用服务的名称.ribbon
#访问策略
service-oss.ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.RoundRobinRule
#同一实例最大重试次数，不包括首次调用次数，默认0
ribbon.MaxAutoRestries=0
#重试其他实例的最大重试次数，不包括首次默认1
ribbon.MaxAutoRestriesNextServer=1
#连接建立的超时时长，默认一秒
ribbon.ConnectTimeout=5000
#处理请求的超时时间，默认1秒
ribbon.ReadTimeout=5000
```



三、删除用户的同时删除oss中的头像