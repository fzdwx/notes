# 一、工程结构

*   **academy_parent**：父工程，管理子模块
    *   **canal_client**:canal数据库表同步模块（统计同步数据）
    *   **common**：公共模块父节点
        *   common_util:工具类模块
        *   service_base：service服务的base包，包含service服务的公共配置类，所有的service都依赖
        *   spring_security：认证和授权模块，需要认证的service服务都依赖
    *   infrastructure:基础服务模块父节点
        *   api_geteway：api服务网关
    *   service：api接口管理父节点
        *   acl：用户权限管理api接口服务（用户管理，角色管理和权限管理）
        *   cms：cms api接口服务
        *   edu：教学相关的接口服务
        *   sms：短信api
        *   order：订单服务
        *   oss：阿里云oss api接口
        *   statistics：统计报表api接口
        *   ucenter：会员api接口
        *   vod：视频点播api接口

# 二、创建项目

## 	academy_parent：

```xml
<properties>
   <java.version>1.8</java.version>
   <mybatis-plus.version>3.3.1</mybatis-plus.version>
   <velocity.version>2.0</velocity.version>
   <swagger.version>2.7.0</swagger.version>
   <aliyun.oss.version>2.8.3</aliyun.oss.version>
   <jodatime.version>2.10.1</jodatime.version>
   <commons-fileupload.version>1.3.1</commons-fileupload.version>
   <commons-io.version>2.6</commons-io.version>
   <commons-lang.version>3.9</commons-lang.version>
   <httpclient.version>4.5.1</httpclient.version>
   <jwt.version>0.7.0</jwt.version>
   <aliyun-java-sdk-core.version>4.3.3</aliyun-java-sdk-core.version>
   <aliyun-sdk-oss.version>3.1.0</aliyun-sdk-oss.version>
   <aliyun-java-sdk-vod.version>2.15.2</aliyun-java-sdk-vod.version>
   <aliyun-java-vod-upload.version>1.4.11</aliyun-java-vod-upload.version>
   <aliyun-sdk-vod-upload.version>1.4.11</aliyun-sdk-vod-upload.version>
   <fastjson.version>1.2.28</fastjson.version>
   <gson.version>2.8.2</gson.version>
   <json.version>20170516</json.version>
   <commons-dbutils.version>1.7</commons-dbutils.version>
   <canal.client.version>1.1.0</canal.client.version>
   <docker.image.prefix>zx</docker.image.prefix>
   <cloud-alibaba.version>0.2.2.RELEASE</cloud-alibaba.version>
</properties>
<dependencyManagement>
   <dependencies>
      <!--Spring Cloud-->
      <dependency>
         <groupId>org.springframework.cloud</groupId>
         <artifactId>spring-cloud-dependencies</artifactId>
         <version>Hoxton.RELEASE</version>
         <type>pom</type>
         <scope>import</scope>
      </dependency>
      <dependency>
         <groupId>org.springframework.cloud</groupId>
         <artifactId>spring-cloud-alibaba-dependencies</artifactId>
         <version>${cloud-alibaba.version}</version>
         <type>pom</type>
         <scope>import</scope>
      </dependency>
      
      <!--mybatis-plus 持久层-->
      <dependency>
         <groupId>com.baomidou</groupId>
         <artifactId>mybatis-plus-boot-starter</artifactId>
         <version>${mybatis-plus.version}</version>
      </dependency>
      <dependency>
         <groupId>com.baomidou</groupId>
         <artifactId>mybatis-plus-generator</artifactId>
         <version>${mybatis-plus.version}</version>
      </dependency>
      
      <!-- velocity 模板引擎, Mybatis Plus 代码生成器需要 -->
      <dependency>
         <groupId>org.apache.velocity</groupId>
         <artifactId>velocity-engine-core</artifactId>
         <version>${velocity.version}</version>
      </dependency>
      
      <!--swagger-->
      <dependency>
         <groupId>io.springfox</groupId>
         <artifactId>springfox-swagger2</artifactId>
         <version>${swagger.version}</version>
      </dependency>
      <!--swagger ui-->
      <dependency>
         <groupId>io.springfox</groupId>
         <artifactId>springfox-swagger-ui</artifactId>
         <version>${swagger.version}</version>
      </dependency>
      
      <!--aliyunOSS-->
      <dependency>
         <groupId>com.aliyun.oss</groupId>
         <artifactId>aliyun-sdk-oss</artifactId>
         <version>${aliyun.oss.version}</version>
      </dependency>
      
      <!--日期时间工具-->
      <dependency>
         <groupId>joda-time</groupId>
         <artifactId>joda-time</artifactId>
         <version>${jodatime.version}</version>
      </dependency>
      
      <!--文件上传-->
      <dependency>
         <groupId>commons-fileupload</groupId>
         <artifactId>commons-fileupload</artifactId>
         <version>${commons-fileupload.version}</version>
      </dependency>
      
      <!--commons-io-->
      <dependency>
         <groupId>commons-io</groupId>
         <artifactId>commons-io</artifactId>
         <version>${commons-io.version}</version>
      </dependency>
      
      <!--commons-lang3-->
      <dependency>
         <groupId>org.apache.commons</groupId>
         <artifactId>commons-lang3</artifactId>
         <version>${commons-lang.version}</version>
      </dependency>
      
      <!--httpclient-->
      <dependency>
         <groupId>org.apache.httpcomponents</groupId>
         <artifactId>httpclient</artifactId>
         <version>${httpclient.version}</version>
      </dependency>
      
      <!-- JWT -->
      <dependency>
         <groupId>io.jsonwebtoken</groupId>
         <artifactId>jjwt</artifactId>
         <version>${jwt.version}</version>
      </dependency>
      
      <!--aliyun-->
      <!--<dependency>
         <groupId>com.aliyun</groupId>
         <artifactId>aliyun-java-sdk-core</artifactId>
         <version>${aliyun-java-sdk-core.version}</version>
      </dependency>
      <dependency>
         <groupId>com.aliyun.oss</groupId>
         <artifactId>aliyun-sdk-oss</artifactId>
         <version>${aliyun-sdk-oss.version}</version>
      </dependency>
      <dependency>
         <groupId>com.aliyun</groupId>
         <artifactId>aliyun-java-sdk-vod</artifactId>
         <version>${aliyun-java-sdk-vod.version}</version>
      </dependency>-->
      <!--<dependency>-->
      <!--<groupId>com.aliyun</groupId>-->
      <!--<artifactId>aliyun-sdk-vod-upload</artifactId>-->
      <!--<version>${aliyun-sdk-vod-upload.version}</version>-->
      <!--</dependency>-->
      
      <!--json-->
      <dependency>
         <groupId>com.alibaba</groupId>
         <artifactId>fastjson</artifactId>
         <version>${fastjson.version}</version>
      </dependency>
      <dependency>
         <groupId>org.json</groupId>
         <artifactId>json</artifactId>
         <version>${json.version}</version>
      </dependency>
      <dependency>
         <groupId>com.google.code.gson</groupId>
         <artifactId>gson</artifactId>
         <version>${gson.version}</version>
      </dependency>

      <dependency>
         <groupId>commons-dbutils</groupId>
         <artifactId>commons-dbutils</artifactId>
         <version>${commons-dbutils.version}</version>
      </dependency>

      <dependency>
         <groupId>com.alibaba.otter</groupId>
         <artifactId>canal.client</artifactId>
         <version>${canal.client.version}</version>
      </dependency>
   </dependencies>
</dependencyManagement>
```





## 	common

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--mybatis-plus-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
    </dependency>

    <!--lombok用来简化实体类：需要安装lombok插件-->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>

    <!--swagger-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
    </dependency>
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
    </dependency>
</dependencies>
```

## service_base

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--mybatis-plus-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
    </dependency>

    <!--lombok用来简化实体类：需要安装lombok插件-->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>

    <!--swagger-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
    </dependency>
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
    </dependency>

</dependencies>
```

## service

```xml
<dependencies>
    <dependency>
        <groupId>com.like</groupId>
        <artifactId>service_base</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--mybatis-plus-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
    </dependency>
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-generator</artifactId>
    </dependency>

    <!--mysql-->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>

    <!-- velocity 模板引擎, Mybatis Plus 代码生成器需要 -->
    <dependency>
        <groupId>org.apache.velocity</groupId>
        <artifactId>velocity-engine-core</artifactId>
    </dependency>

    <!--swagger-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
    </dependency>
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
    </dependency>

    <!--lombok用来简化实体类：需要安装lombok插件-->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>

    <dependency>
        <groupId>commons-fileupload</groupId>
        <artifactId>commons-fileupload</artifactId>
    </dependency>

    <!--httpclient-->
    <dependency>
        <groupId>org.apache.httpcomponents</groupId>
        <artifactId>httpclient</artifactId>
    </dependency>
    <!--commons-io-->
    <dependency>
        <groupId>commons-io</groupId>
        <artifactId>commons-io</artifactId>
    </dependency>

    <!--json-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
    </dependency>
    <dependency>
        <groupId>org.json</groupId>
        <artifactId>json</artifactId>
    </dependency>
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
        <exclusions>
            <exclusion>
                <groupId>org.junit.vintage</groupId>
                <artifactId>junit-vintage-engine</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
</dependencies>
```



# 三、数据库创建

## 数据表创建

~~~sql
/*
SQLyog Ultimate v12.09 (64 bit)
MySQL - 5.7.21-log : Database - guli_edu
*********************************************************************
*/


/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
/*Table structure for table `edu_chapter` */

DROP TABLE IF EXISTS `edu_chapter`;

CREATE TABLE `edu_chapter` (
  `id` char(19) NOT NULL COMMENT '章节ID',
  `course_id` char(19) NOT NULL COMMENT '课程ID',
  `title` varchar(50) NOT NULL COMMENT '章节名称',
  `sort` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '显示排序',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_course_id` (`course_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=COMPACT COMMENT='课程';

/*Data for the table `edu_chapter` */

/*Table structure for table `edu_comment` */

DROP TABLE IF EXISTS `edu_comment`;

CREATE TABLE `edu_comment` (
  `id` char(19) NOT NULL COMMENT '讲师ID',
  `course_id` char(19) NOT NULL DEFAULT '' COMMENT '课程id',
  `teacher_id` char(19) NOT NULL DEFAULT '' COMMENT '讲师id',
  `member_id` char(19) NOT NULL DEFAULT '' COMMENT '会员id',
  `nickname` varchar(50) DEFAULT NULL COMMENT '会员昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '会员头像',
  `content` varchar(500) DEFAULT NULL COMMENT '评论内容',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_course_id` (`course_id`),
  KEY `idx_teacher_id` (`teacher_id`),
  KEY `idx_member_id` (`member_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评论';

/*Data for the table `edu_comment` */

/*Table structure for table `edu_course` */

DROP TABLE IF EXISTS `edu_course`;

CREATE TABLE `edu_course` (
  `id` char(19) NOT NULL COMMENT '课程ID',
  `teacher_id` char(19) NOT NULL COMMENT '课程讲师ID',
  `subject_id` char(19) NOT NULL COMMENT '课程专业ID',
  `subject_parent_id` char(19) NOT NULL COMMENT '课程专业父级ID',
  `title` varchar(50) NOT NULL COMMENT '课程标题',
  `price` decimal(10,2) unsigned NOT NULL DEFAULT '0.00' COMMENT '课程销售价格，设置为0则可免费观看',
  `lesson_num` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '总课时',
  `cover` varchar(255) CHARACTER SET utf8 NOT NULL COMMENT '课程封面图片路径',
  `buy_count` bigint(10) unsigned NOT NULL DEFAULT '0' COMMENT '销售数量',
  `view_count` bigint(10) unsigned NOT NULL DEFAULT '0' COMMENT '浏览数量',
  `version` bigint(20) unsigned NOT NULL DEFAULT '1' COMMENT '乐观锁',
  `status` varchar(10) NOT NULL DEFAULT 'Draft' COMMENT '课程状态 Draft未发布  Normal已发布',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_title` (`title`),
  KEY `idx_subject_id` (`subject_id`),
  KEY `idx_teacher_id` (`teacher_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=COMPACT COMMENT='课程';

/*Data for the table `edu_course` */

/*Table structure for table `edu_course_collect` */

DROP TABLE IF EXISTS `edu_course_collect`;

CREATE TABLE `edu_course_collect` (
  `id` char(19) NOT NULL COMMENT '收藏ID',
  `course_id` char(19) NOT NULL COMMENT '课程讲师ID',
  `member_id` char(19) NOT NULL DEFAULT '' COMMENT '课程专业ID',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=COMPACT COMMENT='课程收藏';

/*Data for the table `edu_course_collect` */

/*Table structure for table `edu_course_description` */

DROP TABLE IF EXISTS `edu_course_description`;

CREATE TABLE `edu_course_description` (
  `id` char(19) NOT NULL COMMENT '课程ID',
  `description` text COMMENT '课程简介',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='课程简介';

/*Data for the table `edu_course_description` */

/*Table structure for table `edu_subject` */

DROP TABLE IF EXISTS `edu_subject`;

CREATE TABLE `edu_subject` (
  `id` char(19) NOT NULL COMMENT '课程类别ID',
  `title` varchar(10) NOT NULL COMMENT '类别名称',
  `parent_id` char(19) NOT NULL DEFAULT '0' COMMENT '父ID',
  `sort` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '排序字段',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=COMPACT COMMENT='课程科目';

/*Data for the table `edu_subject` */

/*Table structure for table `edu_teacher` */

DROP TABLE IF EXISTS `edu_teacher`;

CREATE TABLE `edu_teacher` (
  `id` char(19) NOT NULL COMMENT '讲师ID',
  `name` varchar(20) NOT NULL COMMENT '讲师姓名',
  `intro` varchar(500) NOT NULL DEFAULT '' COMMENT '讲师简介',
  `career` varchar(500) DEFAULT NULL COMMENT '讲师资历,一句话说明讲师',
  `level` int(10) unsigned NOT NULL COMMENT '头衔 1高级讲师 2首席讲师',
  `avatar` varchar(255) DEFAULT NULL COMMENT '讲师头像',
  `sort` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '排序',
  `join_date` date DEFAULT NULL COMMENT '入驻时间',
  `is_deleted` tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '逻辑删除 1（true）已删除， 0（false）未删除',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='讲师';

/*Data for the table `edu_teacher` */

insert  into `edu_teacher`(`id`,`name`,`intro`,`career`,`level`,`avatar`,`sort`,`join_date`,`is_deleted`,`gmt_create`,`gmt_modified`) values ('1','刘德华','毕业于师范大学数学系，热爱教育事业，执教数学思维6年有余','具备深厚的数学思维功底、丰富的小学教育经验，授课风格生动活泼，擅长用形象生动的比喻帮助理解、简单易懂的语言讲解难题，深受学生喜欢',2,'https://online-teach-file-helen.oss-cn-beijing.aliyuncs.com/avatar/2019/11/25/03.jpg',10,'2019-10-29',0,'2018-03-30 17:15:57','2019-04-28 05:02:18'),('10','唐嫣','北京师范大学法学院副教授','北京师范大学法学院副教授、清华大学法学博士。自2004年至今已有9年的司法考试培训经验。长期从事司法考试辅导，深知命题规律，了解解题技巧。内容把握准确，授课重点明确，层次分明，调理清晰，将法条法理与案例有机融合，强调综合，深入浅出。',1,'http://guli-file.oss-cn-beijing.aliyuncs.com/avatar/2019/02/27/073eb5d2-f5f4-488a-82ed-aec8a5289a5d.png',20,'2019-10-29',0,'2018-04-03 14:32:19','2019-02-22 02:01:26'),('2','周润发','中国人民大学附属中学数学一级教师','中国科学院数学与系统科学研究院应用数学专业博士，研究方向为数字图像处理，中国工业与应用数学学会会员。参与全国教育科学“十五”规划重点课题“信息化进程中的教育技术发展研究”的子课题“基与课程改革的资源开发与应用”，以及全国“十五”科研规划全国重点项目“掌上型信息技术产品在教学中的运用和开发研究”的子课题“用技术学数学”。',2,'https://guli-file-helen.oss-cn-beijing.aliyuncs.com/avatar/2020/04/14/f606ed5b-1d46-43a1-945c-3e1b3b58fc0a.jpg',1,'2019-10-28',0,'2018-03-30 18:28:26','2020-04-14 17:40:36'),('3','钟汉良','钟汉良钟汉良钟汉良钟汉良','中教一级职称。讲课极具亲和力。',1,'http://guli-file.oss-cn-beijing.aliyuncs.com/avatar/2019/02/26/250bab5f-bbd6-49ab-80c3-7413ce806e83.jpg',2,'2019-10-29',0,'2018-03-31 09:20:46','2019-02-22 02:01:27'),('4','周杰伦','长期从事考研政治课讲授和考研命题趋势与应试对策研究。考研辅导新锐派的代表。','政治学博士、管理学博士后，北京师范大学马克思主义学院副教授。多年来总结出了一套行之有效的应试技巧与答题方法，针对性和实用性极强，能帮助考生在轻松中应考，在激励的竞争中取得高分，脱颖而出。',1,'https://online-teach-file-helen.oss-cn-beijing.aliyuncs.com/avatar/2019/11/25/fee1e99f-8852-4da0-a256-9732e55bb608.jpg',1,'2019-10-27',0,'2018-04-03 14:13:51','2019-10-29 19:52:46'),('5','陈伟霆','人大附中2009届毕业生','北京大学数学科学学院2008级本科生，2012年第八届学生五四奖章获得者，在数学领域取得多项国际国内奖项，学术研究成绩突出。曾被两次评为北京大学三好学生、一次评为北京大学三好标兵，获得过北京大学国家奖学金、北京大学廖凯原奖学金、北京大学星光国际一等奖学金、北京大学明德新生奖学金等。',1,'',1,'2019-10-29',0,'2018-04-03 14:15:36','2019-02-22 02:01:29'),('6','姚晨','华东师范大学数学系硕士生导师，中国数学奥林匹克高级教练','曾参与北京市及全国多项数学活动的命题和组织工作，多次带领北京队参加高中、初中、小学的各项数学竞赛，均取得优异成绩。教学活而新，能够调动学生的学习兴趣并擅长对学生进行思维点拨，对学生学习习惯的养成和非智力因素培养有独到之处，是一位深受学生喜爱的老师。',1,'',1,'2019-10-29',0,'2018-04-01 14:19:28','2019-02-22 02:01:29'),('7','胡歌','考研政治辅导实战派专家，全国考研政治命题研究组核心成员。','法学博士，北京师范大学马克思主义学院副教授，专攻毛泽东思想概论、邓小平理论，长期从事考研辅导。出版著作两部，发表学术论文30余篇，主持国家社会科学基金项目和教育部重大课题子课题各一项，参与中央实施马克思主义理论研究和建设工程项目。',2,'',8,'2019-09-04',0,'2018-04-03 14:21:03','2019-02-22 02:01:30'),('8','谢娜','资深课程设计专家，专注10年AACTP美国培训协会认证导师','十年课程研发和培训咨询经验，曾任国企人力资源经理、大型外企培训经理，负责企业大学和培训体系搭建；曾任专业培训机构高级顾问、研发部总监，为包括广东移动、东莞移动、深圳移动、南方电网、工商银行、农业银行、民生银行、邮储银行、TCL集团、清华大学继续教育学院、中天路桥、广西扬翔股份等超过200家企业提供过培训与咨询服务，并担任近50个大型项目的总负责人。',1,'',10,'2019-10-29',0,'2018-04-03 14:23:33','2019-11-23 08:38:09');

/*Table structure for table `edu_video` */

DROP TABLE IF EXISTS `edu_video`;

CREATE TABLE `edu_video` (
  `id` char(19) NOT NULL COMMENT '视频ID',
  `course_id` char(19) NOT NULL COMMENT '课程ID',
  `chapter_id` char(19) NOT NULL COMMENT '章节ID',
  `title` varchar(50) NOT NULL COMMENT '节点名称',
  `video_source_id` varchar(100) DEFAULT NULL COMMENT '云端视频资源',
  `video_original_name` varchar(100) DEFAULT NULL COMMENT '原始文件名称',
  `sort` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '排序字段',
  `play_count` bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '播放次数',
  `is_free` tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '是否可以试听：0收费 1免费',
  `duration` float NOT NULL DEFAULT '0' COMMENT '视频时长（秒）',
  `status` varchar(20) NOT NULL DEFAULT 'Empty' COMMENT '状态',
  `size` bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '视频源文件大小（字节）',
  `version` bigint(20) unsigned NOT NULL DEFAULT '1' COMMENT '乐观锁',
  `gmt_create` datetime NOT NULL COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_course_id` (`course_id`),
  KEY `idx_chapter_id` (`chapter_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=COMPACT COMMENT='课程视频';

/*Data for the table `edu_video` */

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
~~~



# 四、逆向

## a.代码生成器

```java
public static void main(String[] args) {
    String prefix = "academy";
    String moduleName = "edu";

    // 1、创建代码生成器
    AutoGenerator mpg = new AutoGenerator();

    // 2、全局配置
    GlobalConfig gc = new GlobalConfig();
    gc.setAuthor("like");
    gc.setOpen(true); //生成后是否打开资源管理器
    gc.setFileOverride(true); //重新生成时文件是否覆盖
    gc.setServiceName("%sService");    //去掉Service接口的首字母I
    gc.setIdType(IdType.ASSIGN_ID); //主键策略
    gc.setDateType(DateType.ONLY_DATE);//定义生成的实体类中日期类型
    gc.setSwagger2(true);//开启Swagger2模式
    mpg.setGlobalConfig(gc);

    // 3、数据源配置
    DataSourceConfig dsc = new DataSourceConfig();
    dsc.setUrl("jdbc:mysql://localhost:3306/" + prefix + "?serverTimezone=GMT%2B8");
    dsc.setDriverName("com.mysql.cj.jdbc.Driver");
    dsc.setUsername("root");
    dsc.setPassword("root");
    dsc.setDbType(DbType.MYSQL);
    mpg.setDataSource(dsc);

    // 4、包配置
    PackageConfig pc = new PackageConfig();
    pc.setModuleName(moduleName); //模块名
    pc.setParent("com.like.academy");
    pc.setController("controller");
    pc.setEntity("entity");
    pc.setService("service");
    pc.setMapper("mapper");
    mpg.setPackageInfo(pc);

    // 5、策略配置
    StrategyConfig strategy = new StrategyConfig();
    strategy.setNaming(NamingStrategy.underline_to_camel);//数据库表映射到实体的命名策略
    strategy.setTablePrefix(moduleName + "_");//设置表前缀不生成
    //
    strategy.setColumnNaming(NamingStrategy.underline_to_camel);//数据库表字段映射到实体的命名策略
    strategy.setEntityLombokModel(true); // lombok 模型 @Accessors(chain = true) setter链式操作

    strategy.setLogicDeleteFieldName("is_deleted");//逻辑删除字段名
    strategy.setEntityBooleanColumnRemoveIsPrefix(true);//去掉布尔值的is_前缀

    //自动填充
    TableFill gmtCreate = new TableFill("gmt_create", FieldFill.INSERT);
    TableFill gmtModified = new TableFill("gmt_modified", FieldFill.INSERT_UPDATE);
    ArrayList<TableFill> tableFills = new ArrayList<>();
    tableFills.add(gmtCreate);
    tableFills.add(gmtModified);
    strategy.setTableFillList(tableFills);

    strategy.setRestControllerStyle(true); //restful api风格控制器
    strategy.setControllerMappingHyphenStyle(true); //url中驼峰转连字符
    mpg.setStrategy(strategy);

    //设置BaseEntity
    strategy.setSuperEntityClass(" com.like.academy.server.base.model.BaseEntity");
    // 填写BaseEntity中的公共字段
    strategy.setSuperEntityColumns("id", "gmt_create", "gmt_modified");

    // 6、执行
    mpg.execute();
}
```





## b.baseentity

```java
package com.like.academy.server.base.model;

import com.baomidou.mybatisplus.annotation.FieldFill;
import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.experimental.Accessors;

import java.io.Serializable;
import java.util.Date;

/**
 * @author likeLove
 * @time 2020-08-20  18:36
 */
@Data
@EqualsAndHashCode (callSuper = false)
@Accessors (chain = true)
public class BaseEntity implements Serializable {

    private static final long serialVersionUID = 1L;

    @ApiModelProperty (value = "讲师ID")
    @TableId (value = "id", type = IdType.ASSIGN_ID)
    private String id;

    @ApiModelProperty (value = "创建时间")
    @TableField (fill = FieldFill.INSERT)
    private Date gmtCreate;

    @ApiModelProperty (value = "更新时间")
    @TableField (fill = FieldFill.INSERT_UPDATE)
    private Date gmtModified;

}
```





# 五、Swagger

## 	1.quick start

>   导入依赖

```xml
<!--swagger-->
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
</dependency>
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger-ui</artifactId>
</dependency>
```



>   SwaggerConfig

在parent.common.service_base中创建com.like.academy.server.base.config.SwaggerConfig

```java
@Configuration
@EnableSwagger2
public class SwaggerConfig {
    @Bean
    public Docket webApiConfig() {
        return  new Docket(DocumentationType.SWAGGER_2);
    }
}
```



>   访问

http://localhost:8888/swagger-ui.html



## 	2.根据用途分组定义Api文档	

```java
@Configuration
@EnableSwagger2
public class SwaggerConfig {
    @Bean
    //网站api测试
    public Docket webApiConfig() {
        return  new Docket(DocumentationType.SWAGGER_2)
            //设置分组名词
            .groupName("webApi")
            //设置分组信息
            .apiInfo(webApiInfo())
            //设置哪些Api请求属于这个组
            .select().paths(Predicates.and(PathSelectors.regex("/api/.*")))
            .build();
    }

    @Bean
    //管理员api测试
    public Docket adminApiConfig() {
        return new Docket(DocumentationType.SWAGGER_2)
            .groupName("adminApi")
            .apiInfo(adminApiInfo())
            .select().paths(Predicates.and(PathSelectors.regex("/admin/.*")))
            .build();
    }
}
```

## 	3.创建对应的ApiInfo



```java
@Configuration
@EnableSwagger2
public class SwaggerConfig {
    
    ···
    
    //针对webApi的文件解析
    private ApiInfo webApiInfo() {
        return new ApiInfoBuilder()
            .title("网站前台Api文档")
            .description("本文档是关于学院的Api接口定义")
            .version("0.1")
            .contact(new Contact("like","https://github.com/likedeke","980650920@qq.com"))
            .build();
    }
    //针对adminApi的解析
    private ApiInfo adminApiInfo() {
        return new ApiInfoBuilder()
            .title("后台管理系统Api文档")
            .description("本文档是关于学院的后台Api接口定义")
            .version("0.1")
            .contact(new Contact("like"
                                 , "https://github.com/likedeke"
                                 , "980650920@qq.com"))
            .build();
    }
}
```

![image-20200821093819530](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821093819.png)

## 4常见注解

### 	a.实体类上

**标注在类上**

@ApiModel(value="Teacher对象", description="讲师")

**标注在字段上**

@ApiModelProperty(value = "讲师姓名")
  	  private String name;

```java
@Data
@EqualsAndHashCode(callSuper = true)
@Accessors(chain = true)
@TableName("edu_teacher")
@ApiModel(value="Teacher对象", description="讲师")
public class Teacher extends BaseEntity {

    private static final long serialVersionUID=1L;

    @ApiModelProperty(value = "讲师姓名")
    private String name;
```



### 	b.标注在controller层

```java
@RestController
@RequestMapping ("/admin/edu/teacher")
@Api(tags = "讲师管理")
public class TeacherController {
   @Autowired
   TeacherService teacherService;

    @GetMapping("")
    @ApiOperation(value = "获取所有讲师列表")
    public List<Teacher> getAllTeacherForList() {
        return teacherService.list();
    }

    @DeleteMapping("/{id}")
    @ApiOperation(value = "根据讲师id删除讲师",notes = "根据讲师id删除讲师,逻辑删除")
    public boolean removeById(@ApiParam(value = "讲师id") @PathVariable String id) {
       return teacherService.removeById(id);
    }
}
```

**效果**

![image-20200821093744426](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821093744.png)







# 六、统一返回数据的格式

在项目中会将响应封装成json返回，我们会将所有接口的数据格式统一

![image-20200821094203874](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821094203.png)

![image-20200821094439482](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821094439.png)

![image-20200821094448162](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821094448.png)

![image-20200821094456409](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821094456.png)

![image-20200821094520728](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821094520.png)



Result运用建造者模式来创建返回结果，枚举类运用了单例模式，列举了所需要的返回状态信息



## 1.定义一个统一的返回结果类

```java
@Data
@ApiModel(value = "全局统一返回结果")
public class Result {

    @ApiModelProperty(value = "是否成功")
    private Boolean success;

    @ApiModelProperty(value = "返回码")
    private Integer code;

    @ApiModelProperty(value = "返回消息")
    private String message;

    @ApiModelProperty(value = "返回数据")
    private Map<String, Object> data = new HashMap<String, Object>();

    public Result(){}

    public static Result ok(){
        Result result = new Result();
        result.setSuccess(ResultCodeEnum.SUCCESS.getSuccess());
        result.setCode(ResultCodeEnum.SUCCESS.getCode());
        result.setMessage(ResultCodeEnum.SUCCESS.getMessage());
        return result;
    }

    public static Result error(){
        Result result = new Result();
        result.setSuccess(ResultCodeEnum.UNKNOWN_REASON.getSuccess());
        result.setCode(ResultCodeEnum.UNKNOWN_REASON.getCode());
        result.setMessage(ResultCodeEnum.UNKNOWN_REASON.getMessage());
        return result;
    }

    public static Result setResult(ResultCodeEnum resultCodeEnum){
        Result result = new Result();
        result.setSuccess(resultCodeEnum.getSuccess());
        result.setCode(resultCodeEnum.getCode());
        result.setMessage(resultCodeEnum.getMessage());
        return result;
    }

    public Result success(Boolean success){
        this.setSuccess(success);
        return this;
    }

    public Result message(String message){
        this.setMessage(message);
        return this;
    }

    public Result code(Integer code){
        this.setCode(code);
        return this;
    }

    public Result data(String key, Object value){
        this.data.put(key, value);
        return this;
    }

    public Result data(Map<String, Object> map){
        this.setData(map);
        return this;
    }
}
```



## 2.定义一个枚举类里面有所需要的返回状态信息

```java
@Getter
@ToString
public enum ResultCodeEnum {
    /**
     * 成功
     */
    SUCCESS(true, 20000,"成功"),
    /**
     * 未知错误
     */
    UNKNOWN_REASON(false, 20001, "未知错误"),
    /**
     * sql语法错误
     */
    BAD_SQL_GRAMMAR(false, 21001, "sql语法错误"),
    /**
     * json解析异常
     */
    JSON_PARSE_ERROR(false, 21002, "json解析异常"),
    PARAM_ERROR(false, 21003, "参数不正确"),

    FILE_UPLOAD_ERROR(false, 21004, "文件上传错误"),
    FILE_DELETE_ERROR(false, 21005, "文件刪除错误"),
    EXCEL_DATA_IMPORT_ERROR(false, 21006, "Excel数据导入错误"),

    VIDEO_UPLOAD_ALIYUN_ERROR(false, 22001, "视频上传至阿里云失败"),
    VIDEO_UPLOAD_TOMCAT_ERROR(false, 22002, "视频上传至业务服务器失败"),
    VIDEO_DELETE_ALIYUN_ERROR(false, 22003, "阿里云视频文件删除失败"),
    FETCH_VIDEO_UPLOADAUTH_ERROR(false, 22004, "获取上传地址和凭证失败"),
    REFRESH_VIDEO_UPLOADAUTH_ERROR(false, 22005, "刷新上传地址和凭证失败"),
    FETCH_PLAYAUTH_ERROR(false, 22006, "获取播放凭证失败"),

    URL_ENCODE_ERROR(false, 23001, "URL编码失败"),
    ILLEGAL_CALLBACK_REQUEST_ERROR(false, 23002, "非法回调请求"),
    FETCH_ACCESSTOKEN_FAILD(false, 23003, "获取accessToken失败"),
    FETCH_USERINFO_ERROR(false, 23004, "获取用户信息失败"),
    LOGIN_ERROR(false, 23005, "登录失败"),

    COMMENT_EMPTY(false, 24006, "评论内容必须填写"),

    PAY_RUN(false, 25000, "支付中"),
    PAY_UNIFIEDORDER_ERROR(false, 25001, "统一下单错误"),
    PAY_ORDERQUERY_ERROR(false, 25002, "查询支付结果错误"),

    ORDER_EXIST_ERROR(false, 25003, "课程已购买"),

    GATEWAY_ERROR(false, 26000, "服务不能访问"),

    CODE_ERROR(false, 28000, "验证码错误"),

    LOGIN_PHONE_ERROR(false, 28009, "手机号码不正确"),
    LOGIN_MOBILE_ERROR(false, 28001, "账号不正确"),
    LOGIN_PASSWORD_ERROR(false, 28008, "密码不正确"),
    LOGIN_DISABLED_ERROR(false, 28002, "该用户已被禁用"),
    REGISTER_MOBLE_ERROR(false, 28003, "手机号已被注册"),
    LOGIN_AUTH(false, 28004, "需要登录"),
    LOGIN_ACL(false, 28005, "没有权限"),
    SMS_SEND_ERROR(false, 28006, "短信发送失败"),
    SMS_SEND_ERROR_BUSINESS_LIMIT_CONTROL(false, 28007, "短信发送过于频繁");


    private Boolean success;

    private Integer code;

    private String message;

    ResultCodeEnum(Boolean success, Integer code, String message) {
        this.success = success;
        this.code = code;
        this.message = message;
    }
}
```



```java
@RestController
@RequestMapping ("/admin/edu/teacher")
@Api (tags = "讲师管理")
public class TeacherController {
   @Autowired
   TeacherService teacherService;

    @GetMapping("")
    @ApiOperation(value = "获取所有讲师列表")
    public Result getAllTeacherForList() {
        List<Teacher> list = teacherService.list();
        return Result.ok().data("items", list);
    }

    @DeleteMapping("/{id}")
    @ApiOperation(value = "根据讲师id删除讲师",notes = "根据讲师id删除讲师,逻辑删除")
    public Result removeById(@ApiParam(value = "讲师id") @PathVariable String id) {
        boolean b = teacherService.removeById(id);
        String massage;
        if (b) {
            return Result.ok().message("删除成功");
        }
        else {
           return Result.error().message("删除失败");
        }
    }
}
```



![image-20200821100700610](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821100700.png)

![image-20200821100641839](https://gitee.com/likeloveC/picture_bed/raw/master/img/20200821100641.png)



# 七、添加teacherControlloer的功能

## 1.添加分页功能

```java
@RestController
@RequestMapping ("/admin/edu/teacher")
@Api (tags = "讲师管理")
public class TeacherController {
    
    ···        
    @ApiOperation ("讲师分页列表")
    @GetMapping ("/{page}/{limit}")
    public Result pageList(@ApiParam ("当前页码") @PathVariable long page,
                           @ApiParam ("每页有多少条记录") @PathVariable long limit) {
        Page<Teacher> pageParam = new Page<>(page, limit);
        IPage<Teacher> pageModel = teacherService.page(pageParam);
        List<Teacher> records = pageModel.getRecords();//获取分页的数据
        long total = pageModel.getTotal();//总记录条数
        return Result.ok().data("total",total).data("rows",records);
    }
}
```



## 2.使用teacher条件查询对象改进分页功能

>   创建TeacherQueryVo对象

```java
@Data
@ApiModel (value = "Teacher条件查询对象", description = "讲师条件查询对象")
public class TeacherQueryVo implements Serializable {

    private static final long serialVersionUID = 3647151358861270122L;

    @ApiModelProperty (value = "讲师姓名", example = "李老师")
    private String name;

    @ApiModelProperty (value = "头衔 1高级讲师 2首席讲师")
    private Integer lever;

    @ApiModelProperty (value = "加入时间范围的起始时间")
    private String joinDateBegin;

    @ApiModelProperty (value = "加入时间范围的结尾时间")
    private String joinDateEnd;
}
```



>   在service层添加方法并实现

```java
public interface TeacherService extends IService<Teacher> {
    /**
     * 根据讲师条件查询对象查询分页
     * @param pageParam 分页信息：当前多少页，每页多少条信息
     * @param teacherQueryVo  讲师分页查询条件对象
     * @return IPage
     */
    IPage<Teacher> selectPage(Page<Teacher> pageParam, TeacherQueryVo teacherQueryVo);
}
```

**实现：**

```java
@Service
public class TeacherServiceImpl extends ServiceImpl<TeacherMapper, Teacher>
        implements TeacherService {
    @Override
    public IPage<Teacher> selectPage(Page<Teacher> pageParam, TeacherQueryVo teacherQueryVo) {
        //1.默认按照表中的sort字段排序
        QueryWrapper<Teacher> query = new QueryWrapper<>();
        query.orderByAsc("sort");
        if (teacherQueryVo == null) {
            return baseMapper.selectPage(pageParam, query);
        }
        //2.按照传入的teacher分页查询条件对象查询
        String name = teacherQueryVo.getName();
        Integer lever = teacherQueryVo.getLever();
        String joinDateBegin = teacherQueryVo.getJoinDateBegin();
        String joinDateEnd = teacherQueryVo.getJoinDateEnd();
        if (!StringUtils.isEmpty(name)) {//如果name不为空 like "name%"
            query.likeRight("name", name);
        }
        if (lever != null) {//如果lever不为null  lever== xx
            query.eq("lever", lever);
        }
        if (!StringUtils.isEmpty(joinDateBegin)) {//如果不为空 join_date<=
            query.ge("join_date", joinDateBegin);
        }
        if (!StringUtils.isEmpty(joinDateBegin)) {//如果不为空 join_date>=
            query.le("join_date", joinDateEnd);
        }
        return baseMapper.selectPage(pageParam, query);
    }
}
```



## 3.添加添加，修改，删除功能和自动填充

```java
@RestController
@RequestMapping ("/admin/edu/teacher")
@Api (tags = "讲师管理")
public class TeacherController {
    ···
        
    @GetMapping ("/{id}")
    @ApiOperation (value = "根据id获取讲师")
    public Result getTeacherById(@ApiParam("讲师id") @PathVariable String id) {
        Teacher teacher = teacherService.getById(id);
        if (teacher!=null) {
            return Result.ok().data("item",teacher);
        }
        return Result.error().message("讲师不存在");
    }
    @PostMapping ("")
    @ApiOperation (value = "添加讲师")
    public Result save( @ApiParam("需要添加的讲师") @RequestBody  Teacher teacher) {
        boolean save = teacherService.save(teacher);
        if (save) {
            return Result.ok().message("保存成功");
        }
        return Result.error().message("保存失败");
    }

    @PutMapping ("")
    @ApiOperation (value = "修改讲师信息")
    public Result updateById(@ApiParam ("需要修改的讲师") @RequestBody Teacher teacher) {
        boolean save = teacherService.updateById(teacher);
        if (save) {
            return Result.ok().message("修改成功");
        }
        return Result.error().message("修改失败");
    }

    @DeleteMapping ("/{id}")
    @ApiOperation (value = "根据讲师id删除讲师", notes = "根据讲师id删除讲师,逻辑删除")
    public Result removeById(@ApiParam (value = "讲师id") @PathVariable String id) {
        boolean b = teacherService.removeById(id);
        if (b) {
            return Result.ok().message("删除成功");
        }
        else {
            return Result.error().message("删除失败");
        }
    }
}

```



>   自动填充功能

```java
package com.like.academy.server.base.handle;

import com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;
import org.apache.ibatis.reflection.MetaObject;
import org.springframework.stereotype.Component;

import java.util.Date;

/**
 * 自动填充功能
 * @author likeLove
 * @time 2020-08-21  12:33
 */
@Component
public class MyMetaObjectHandler  implements MetaObjectHandler {

    /**
     * 插入元对象字段填充（用于插入时对公共字段的填充）
     *
     * @param metaObject 元对象
     */
    @Override
    public void insertFill(MetaObject metaObject) {
        this.setFieldValByName("gmtCreate",new Date(),metaObject);
        this.setFieldValByName("gmtModified",new Date(),metaObject);
    }

    /**
     * 更新元对象字段填充（用于更新时对公共字段的填充）
     *
     * @param metaObject 元对象
     */
    @Override
    public void updateFill(MetaObject metaObject) {
        this.setFieldValByName("gmtModified", new Date(), metaObject);
    }
}
```



# 八、统一异常处理

```java
package com.like.academy.server.base.handle;

/**
 * 全局异常处理器
 * @author likeLove
 * @time 2020-08-21  13:28
 */
@ControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Result error(Exception e) {
        System.out.println("运行了");
        return Result.error();
    }

    @ExceptionHandler (BadSqlGrammarException.class)
    @ResponseBody
    public Result error(BadSqlGrammarException e) {
        return Result.setResult(ResultCodeEnum.BAD_SQL_GRAMMAR);
    }

    @ExceptionHandler (HttpMessageNotReadableException.class)
    @ResponseBody
    public Result error(HttpMessageNotReadableException e) {     
        return Result.setResult(ResultCodeEnum.JSON_PARSE_ERROR);
    }
}
```



# 九、统一日志处理

## 1.配置logback日志

创建logback-spring.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration scan = "true" scanPeriod = "10 seconds">

    <contextName>logback</contextName>

    <property name = "log.path" value = "D:/Java/project/academy/java/academy_parent/springLog" />
   
   <!--控制台日志格式：彩色日志-->
   <!-- magenta:洋红 -->
   <!-- boldMagenta:粗红-->
   <!-- cyan:青色 -->
   <!-- white:白色 -->
   <!-- magenta:洋红 -->
   <property name = "CONSOLE_LOG_PATTERN"
             value = "%yellow(%date{yyyy-MM-dd HH:mm:ss}) |%highlight(%-5level) |%blue(%thread) |%blue(%file:%line) |%green(%logger) |%cyan(%msg%n)" />
   
   <!--文件日志格式-->
   <property name = "FILE_LOG_PATTERN"
             value = "%date{yyyy-MM-dd HH:mm:ss} |%-5level |%thread |%file:%line |%logger |%msg%n" />
   
   <!--编码-->
   <property name = "ENCODING"
             value = "UTF-8" />
   
   <!--输出到控制台-->
   <appender name = "CONSOLE" class = "ch.qos.logback.core.ConsoleAppender">
        <filter class = "ch.qos.logback.classic.filter.ThresholdFilter">
            <!--日志级别-->
           <level>DEBUG</level>
        </filter>
        <encoder>
            <!--日志格式-->
           <Pattern>${CONSOLE_LOG_PATTERN}</Pattern>
           <!--日志字符集-->
           <charset>${ENCODING}</charset>
        </encoder>
    </appender>
   
   <!--输出到文件-->
   <appender name = "INFO_FILE" class = "ch.qos.logback.core.rolling.RollingFileAppender">
        <!--日志过滤器：此日志文件只记录INFO级别的-->
      <filter class = "ch.qos.logback.classic.filter.LevelFilter">
            <level>INFO</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
      <!-- 正在记录的日志文件的路径及文件名 -->
      <file>${log.path}/log_info.log</file>
        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>${ENCODING}</charset>
        </encoder>
      <!-- 日志记录器的滚动策略，按日期，按大小记录 -->
      <rollingPolicy class = "ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- 每天日志归档路径以及格式 -->
         <fileNamePattern>${log.path}/info/log-info-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class = "ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>500MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
         <!--日志文件保留天数-->
         <maxHistory>15</maxHistory>
        </rollingPolicy>
    </appender>

    <appender name = "WARN_FILE" class = "ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- 日志过滤器：此日志文件只记录WARN级别的 -->
       <filter class = "ch.qos.logback.classic.filter.LevelFilter">
            <level>WARN</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
       <!-- 正在记录的日志文件的路径及文件名 -->
       <file>${log.path}/log_warn.log</file>
        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>${ENCODING}</charset> <!-- 此处设置字符集 -->
        </encoder>
       <!-- 日志记录器的滚动策略，按日期，按大小记录 -->
       <rollingPolicy class = "ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${log.path}/warn/log-warn-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class = "ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
          <!--日志文件保留天数-->
          <maxHistory>15</maxHistory>
        </rollingPolicy>
    </appender>

    <appender name = "ERROR_FILE" class = "ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- 日志过滤器：此日志文件只记录ERROR级别的 -->
       <filter class = "ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
       <!-- 正在记录的日志文件的路径及文件名 -->
       <file>${log.path}/log_error.log</file>
        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>${ENCODING}</charset> <!-- 此处设置字符集 -->
        </encoder>
       <!-- 日志记录器的滚动策略，按日期，按大小记录 -->
       <rollingPolicy class = "ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${log.path}/error/log-error-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class = "ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
          <!--日志文件保留天数-->
          <maxHistory>15</maxHistory>
        </rollingPolicy>
    </appender>
   
   <!--开发环境-->
   <springProfile name = "dev">
        <!--可以灵活设置此处，从而控制日志的输出-->
      <root level = "INFO">
            <appender-ref ref = "CONSOLE" />
            <appender-ref ref = "INFO_FILE" />
            <appender-ref ref = "WARN_FILE" />
            <appender-ref ref = "ERROR_FILE" />
        </root>
    </springProfile>
   
   <!--生产环境-->
   <springProfile name = "pro">
        <root level = "ERROR">
            <appender-ref ref = "ERROR_FILE" />
        </root>
    </springProfile>

</configuration>
```



## 2.创建ExceptionUtils

```java
package com.lk.academy.common.base.util;

import java.io.IOException;
import java.io.PrintWriter;
import java.io.StringWriter;

/**
 * @author helen
 * @since 2019/9/25
 */
public class ExceptionUtils {

    public static String getMessage(Exception e) {
        StringWriter sw = null;
        PrintWriter pw = null;
        try {
            sw = new StringWriter();
            pw = new PrintWriter(sw);
            // 将出错的栈信息输出到printWriter中
            e.printStackTrace(pw);
            pw.flush();
            sw.flush();
        } finally {
            if (sw != null) {
                try {
                    sw.close();
                } catch (IOException e1) {
                    e1.printStackTrace();
                }
            }
            if (pw != null) {
                pw.close();
            }
        }
        return sw.toString();
    }
}
```



## 3.使用

在需要配置的类上加@Slf4j



```java
@ControllerAdvice
@Slf4j
public class MyGlobalExceptionHandler {

    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Result error(Exception e) {
        log.error(ExceptionUtils.getMessage(e));
        return Result.error();
    }

    @ExceptionHandler (BadSqlGrammarException.class)
    @ResponseBody
    public Result error(BadSqlGrammarException e) {
        log.error(ExceptionUtils.getMessage(e));
        return Result.setResult(ResultCodeEnum.BAD_SQL_GRAMMAR);
    }

    @ExceptionHandler (HttpMessageNotReadableException.class)
    @ResponseBody
    public Result error(HttpMessageNotReadableException e) {
        log.error(ExceptionUtils.getMessage(e));
        return Result.setResult(ResultCodeEnum.JSON_PARSE_ERROR);
    }
}
```





# 十、自定义异常

### a.自定义异常类

```java
package com.like.academy.server.base.excetpion;
@Data
public class AcademyException extends RuntimeException {
    private Integer code;
    public AcademyException(String message,Integer code) {
        super(message);
        this.code = code;
    }
    public AcademyException(ResultCodeEnum result) {
        super(result.getMessage());
        this.code = result.getCode();
    }
    @Override
    public String toString() {
        return "AcademyException{" + "message='" + this.getMessage() + '\'' + ", code=" + code + '}';
    }
}
```



### b.在全局异常类中定义一个方法捕获这个异常

~~~java
package com.like.academy.server.base.handle;

@ControllerAdvice
@Slf4j
public class MyGlobalExceptionHandler {
	```
	  //捕获自定义异常
    @ExceptionHandler (AcademyException.class)
    @ResponseBody
    public Result error(AcademyException e) {
        log.error(ExceptionUtils.getMessage(e));
        return Result.error().message(e.getMessage()).code(e.getCode());
    }
}
~~~



### c.在fileController中捕获异常

![image-20200826214001847](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20200828115722.png)



### d.在form中定义页面异常方法

![image-20200826214052601](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20200828115722.png)



# 十一、批量删除教师

![image-20200828120137765](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20200828120137.png)

##  a.后端api

~~~java
@CrossOrigin
@RestController
@RequestMapping ("/admin/edu/teacher")
@Api (tags = "讲师管理")
public class TeacherController {
    ···
    @DeleteMapping ("/batch-remove")
    @ApiOperation (value = "根据讲师id删除讲师", notes = "根据讲师id列表删除讲师,逻辑删除")
    public Result removeByIdList(
        @ApiParam (value = "讲师id列表",required = true)
        @RequestBody List<String> idList) {
        boolean b = teacherService.removeByIds(idList);
        if (b) {
            return Result.ok().message("删除成功");
        }
        else {
            return Result.error().message("删除失败");
        }
    }
}
~~~

## b.前端API

```js
export default {
		
    ···
    //根据id列表删除
    batchRemove(idList) {
        return request({
            url: '/admin/edu/teacher/batch-remove',
            method: 'delete',
            data: idList
        })
    },
}
```

## c.前端模板

```vue
<!--工具条-->
<!--批量删除按钮-->
<div style="padding: 10px">
    <el-button type="danger" size="small" @click="batchRemove()" icon="el-icon-delete">批量删除</el-button>
</div>
<!--显示讲师列表-->
<el-table :data="list" 
          border 
          stripe
          //当发生点击时
          @selection-change="handleSelectionChange">
    <!--多选框-->
    <el-table-column type="selection"/>
</el-table>
```



## d.前端脚本

```js
//批量删除
batchRemove() {
  //判断idList是否为空
  if (this.selections.length === 0) {
    this.$message({
      type:'warning',
      message:'请选择后在删除',
    })
    return ;
  }
  //弹出消息
  this.$confirm('此操作将永久删除该记录, 是否继续?', '提示', {
    confirmButtonText: '确定',
    cancelButtonText: '取消',
    type: 'error'
  }).then(() => {
    //获取id
    let idList =[]
    this.selections.forEach(Item => {
      idList.push(Item.id)
    });
    //执行删除
    teacher.batchRemove(idList)
      .then(response => {
      //重新请求数据
      this.getData()
      //弹出提示
      this.$message({
        type: 'success',
        message: result.message
      })
    })
  }).catch(() => {
    this.$message({
      type: 'info',
      message: '已取消删除'
    })
  });
},
//当点击选择框
handleSelectionChange(selection) {
  this.selections=selection
},
```





# 十二、搜索框返回建议列表的数据

![image-20200828120119448](https://gitee.com/likeloveC/picture_bed/raw/master/img/8.26/20200828120119.png)

## 	1.java

### a.controller

~~~java
@CrossOrigin
@RestController
@RequestMapping ("/admin/edu/teacher")
@Api (tags = "讲师管理")
public class TeacherController {
    ```
    /**
 * 根据关键字查询讲师名列表
 * @param key 关键字
 * @return Result
 */
    @ApiOperation ("根据关键字查询讲师名列表")
    @GetMapping ("/list/{key}")
    public Result selectNameListByKey(@ApiParam (value = "关键字", required = true) @PathVariable String key) {
        List<Map<String, Object>> nameList = teacherService.selectNameList(key);
        return Result.ok().data("nameList", nameList);
    }
}
~~~

### 	b.service

```java
@Service
public class TeacherServiceImpl extends ServiceImpl<TeacherMapper, Teacher>
    implements TeacherService {
    /**
 * 根据输入的key模糊查询数据库中的姓名
 *
 * @param key 姓名
 *
 * @return name：TeacherName
 */
    @Override
    public List<Map<String, Object>> selectNameList(String key) {

        QueryWrapper<Teacher> queryWrapper = new QueryWrapper<>();
        queryWrapper.select("name");
        queryWrapper.like("name",key);
        return baseMapper.selectMaps(queryWrapper);
    }
}
```

## 2.front

### a.api

```js
selectTeacherNameByKey(key) {
  return request({
    url: '/admin/edu/teacher/list/'+key,
    method: 'get',
  });
}
```

## b.list.vue

```vue
<el-form-item>
  <!--输入建议-->
  <el-autocomplete
    class="inline-input"
    v-model="searchObj.name"
    :fetch-suggestions="querySearch"
    placeholder="讲师姓名"
    :trigger-on-focus="false"
    value-key="name"
  ></el-autocomplete>
```

## c.list.js

```js
//当点击选择框
handleSelectionChange(selection) {
  this.selections=selection
},
querySearch(queryString, callback) {
teacher.selectTeacherNameByKey(queryString).then(response => {
    callback(response.data.nameList)
  })
},
```

